# ルーティングその他

## 概要


## 経路選択アルゴリズム

ルーティングテーブルに格納されようとする経路情報は重複していたりする場合があります。
たとえば、以下の図のトポロジにおいて、
R1はスタティックルートで「10.2.0.0/16へは10.0.0.2(R2)を経由する」という設定をされたうえで、
OSPFで他のルーターから「10.2.0.0/16へは10.0.0.3(R3)を経由する」という情報を受け取るかもしれません。

![image](./0040_image/01.png)

このようなシナリオでどの経路を利用するかということはルーターの「**経路選択のアルゴリズム**」に依存します。
スタティックルートやルーティングプロトコルで学んだ経路情報がどのようにルーティングテーブルに反映されるか、
宛先にマッチするルーティングテーブルのエントリが複数ある場合にどれが選ばれるかというルールは厳密に決まっています。

細かな違いはあるかもしれませんが、経路選択のアルゴリズムはネットワーク機器のベンダーに大きく依存してはいません。
利用する経路情報はおおまかに以下の順序で決まります。

0. プレフィックス長(サブネットの値)の比較
0. AD値(どの学習方法を優先するか)の比較
0. メトリック(通信コスト)の比較

複数あるルーティングテーブルのエントリのうち、
最も宛先アドレスを正確に合致するエントリを選ぶというルールがあります。
具体的には192.168.1.102に対してパケットを転送する場合に、
「192.168.0.0/16はR2経由」「192.168.1.0/24はR3経由」というエントリが同時に存在していたとすると、
後者を優先してR3宛にパケットを転送します。
「正確に合致する」ということは「プレフィック(サブネットマスク)がより厳密」と言い換えられます。

次に経路学習のおおもとの信頼性に応じて、利用する経路情報を選択するというルールが適用されます。
たとえば、スタティックルートで「192.168.1.0/24はR2経由」と設定されており、
OSPFでも「192.168.1.0/24はR3経由」と学習しているとしましょう。
このとき、スタティックルートの情報はOSPFよりも信頼されるとルーターは判断するため、
「192.168.1.0/24はR2経由」というエントリを採用して転送します。
どの学習元の情報の信頼性が高いかということはAD値というパラメーターで管理されています。
ルーティングテーブルには一番信頼できる情報源のエントリしか存在しません。

最後のルールがメトリックです。
OSPFで「192.168.1.0/24はR2経由」「192.168.1.0/24はR3経由」という情報を学んだとします。
2つの経路情報は、ともに同じ宛先に対するものでプレフィックスも全く同じです。
学習元はともにOSPFであるため信頼性も同じです。
このような状況では通信コストが低い最短経路を利用します。
その判断に用いられるのがメトリックと呼ばれる情報です。
メトリックの基準はルーティングプロトコルにより異なり、
RIPではホップ数という単純なものですが、OSPFでは途中の経路の帯域が用いられます。
ルーティングテーブルにはメトリックが最小(最もコストが低い)のエントリしか存在しません。

メトリックも同一の複数経路があった場合にどうなるかは機器の種類やルーティングプロトコル、設定により異なります。
どれか一つを使う場合もあれば、複数の経路を同時に使ってロードバランスすることもあります。

以下でこれらのルールの詳細について順に扱います。

### プレフィックス長の比較

経路選択においていちばん重要なルールは「経路がより詳細に指定されているエントリを優先する」というものです。
具体的には宛先IPに該当する複数のエントリがあった場合は、
「**サブネットマスクの長さ(プレフィックス長)が長いエントリを、短いエントリより優先する**」ということです。
どのような信頼できない情報元であっても、どれほど宛先までの通信コストが大きかろうと、
転送にはより詳細な経路のエントリが選択されます。

たとえばスタティックルートで設定した「192.168.0.0/16は10.0.0.2経由」というエントリと、
OSPFで学習した「192.168.1.0/24は10.0.0.3経由」というエントリがあるとします。
このとき、「192.168.1.102」宛のパケットは上記2つのエントリのどちらにも合致します。
ただ、プレフィックス長「/24」は宛先アドレスのうち24bitにマッチしているのに対し、
「/16」は16bitにしかマッチしていません。

よりマッチしているほうが、より正確に宛先アドレスに合致しているエントリであるため、
宛先「192.168.1.102」宛のパケットには「192.168.1.0/24は10.0.0.3経由」というOSPFで学習したエントリが採用され、
パケットは10.0.0.3に転送されます。

![image](./0040_image/02.png)

なお、プレフィックス長が長いというのは、合致するエントリの数が少ないということでもあります。
たとえば「192.168.2.103」宛のパケットを受け取った場合は、
「192.168.1.0/24は10.0.0.3経由」というエントリはマッチしないので、
「192.168.0.0/16は10.0.0.2経由」というエントリが採用されます。

実際にTracerouteを使って、この動きを確認します。

```text
ルーティングテーブルの表示
```

```text
Tracerouteの表示
```


### AD値の比較

経路学習には様々な手法やプロトコルがあります。
たとえば管理者が手動で設定するスタティックルートや、OSPFによる自動学習などです。
そのような状況では同一の宛先に対する経路情報を複数のソースから学ぶ可能性があり、
スタティックルートでは「192.168.1.0/24は10.0.0.2経由」とあり、
OSPFでは「192.168.1.0/24は10.0.0.3経由」といった異なる状況になることもありえます。

そのような状況下でどのソースの経路情報を採用してルーティングテーブルのエントリにするかを判断するため、
経路の学習元には信頼性が設定されており、
それは「**AD値(Administrative Distance)**」と呼ばれています。
AD値は「**値が低いものが優先される**」というルールがあります。
同一の経路情報を複数の学習元から学習していると、
ルーティングテーブルのエントリには最も信頼されるエントリ(つまりAD値が低いもの)しかのりません。

CiscoのルーターにおけるデフォルトのAD値は以下のようになっています。
学んでいないプロトコルなどもあるので知らないものは無視してもらって構いませんが、
今まで学んだものだと「直接接続されるネットワーク」「スタティックルート」「OSPF」という順で経路を選択することがわかります。

```text
接続済み	0
スタティック	1
eBGP	20
EIGRP（内部）	90
IGRP	100
OSPF	110
IS-IS	115
RIP	120
EIGRP（外部）	170
iBGP	200
EIGRP サマリー ルート	5
```

このデフォルトのAD値には「自動学習したものより自分で設定したものを優先する」といった常識的なルールが適用されています。
EIGRPというCisco独自のルーティングプロトコルをOSPFより優先するといった点もありますが、
組織内で複数のルーティングプロトコルを同時に動かすことは滅多にないため考慮は不要かと思います。
ただ、BGPは他のルーティングプロトコルと共用されることがあるため、若干注意が必要です。

このAD値を考慮すると、スタティックルートで学んだ「192.168.1.0/24は10.0.0.2経由」という情報は、
OSPFで学んだ「192.168.1.0/24は10.0.0.3経由」という情報よりも信頼されることがわかります。
そのため、ルーティングテーブルのエントリには「192.168.1.0/24は10.0.0.2経由」と記載されます。

![image](./0040_image/03.png)

```text
ルーティングテーブルの表示
```

```text
Tracerouteの表示
```

AD値を意識しなければいけないようなネットワークを構築することは可能な限り避けて下さい。
複数のソースで複雑なエントリを構築しているということは、
理解しにくいネットワーク構造になっている可能性が高いです。


### メトリックの比較

「**メトリック**」は各ルーティングプロトコル内での経路選択のルールです。

組織内で使われるIGPのプロトコル群では考え方こそ違うものの最も適した経路を選ぶようにメトリックが決められています。
RIPであれば目的地までのホップ数(ルーティングの回数)であり、
他のプロトコルは帯域幅を優先して同じであれば短いものを選ぶというルールです。
組織感で使われるEGPのプロトコル、つまりBGPは最短経路ではなく組織感の調整で決められた経路を使うようにメトリックを設定できます。
IGPに比べるとかなり複雑なメトリックが利用されます。

メトリックはそれぞれのプロトコル内で使われるものなので、
RIPのメトリックはOSPFにとっては意味はありません。
同一のプロトコルが知る「同一の宛先への経路」が複数ある場合に、
メトリックを使ってどれを利用するか決めます。

たとえばOSPFが「192.168.1.0/24は10.0.0.2経由」「192.168.1.0/24は10.0.0.3経由」という2つを学んでいるとします。
プレフィックス値は同一であり、ともにAD値はOSPFであるため、これだけでは経路の優劣はつけられません。
ただ、以下の図のような構成ではR1から見れば、192.168.1.0/24のネットワークにたどり着くには10.0.0.3経由よりも、
10.0.0.2経由のほうが近いです。
全てのリンクの速度が同じだとすれば10.0.0.2経由の経路のメトリックが小さくなるため、
「192.168.1.0/24は10.0.0.2経由」がOSPFが持つ経路情報として採用されます。

![image](./0040_image/04.png)

RIP以外のIGPプロトコルにおいては「経路上の最小帯域幅が最も大きい経路を選ぶ」というのが基本ルールで、
帯域幅に違いがなければホップ数(通過するルーターの数。L2ではなくL3なのでスイッチは含まない)が最も近い経路を選びます。
最小帯域幅が基準になるので、経路の一部が10Gであっても、間に100Mがあれば、それは100Mの経路です。
その100Mの経路よりは「経路上に10Gはなくても、全てが1Gとなっている経路」が一般的には採用されます。

```text
ルーティングテーブルの表示
```

```text
Tracerouteの表示
```


## デフォルトルート

ルーティングテーブルにエントリがない宛先へのパケットはルーターで破棄されてしまいます。
「**デフォルトルート**」はPCで設定するデフォルトゲートウェイのルーター版であり、
特別に指定されていない宛先は全てこのアドレスに転送をするというものです。

デフォルトルートの設定をすることで、
ルーティングテーブルのエントリに「全てのネットワークの宛先はここに送る」というものを加えます。
受け取ったパケットは全てそのエントリに該当するので、
宛先不明として破棄されるパケットがなくなります。

全てのアドレスが該当するネットワークアドレスは「**0.0.0.0/0**」となります。
サブネットマスクで「255.255.255.0」とすると「/24」で256ホストのネットワークとなり、
「255.255.0.0」とすると「/16」で「256 x 256」ホストのネットワークを示します。
どんどんサブネットを小さくしていくと、「0.0.0.0」となり「256 x 256 x 256 x 256」のホストのネットワークを示すため、
つまりは世界中のホスト全てを含む巨大なネットワークを示します。

ルーティングテーブルに書かれるエントリは必ずしも現実に存在するネットワークである必要はなく、
あくまでも転送ルールにすぎません。
「0.0.0.0/0」というネットワークはインターネットには存在しませんが、
ルーティングテーブルのエントリとしては問題ありません。

「10.0.0.0/16」は「10.0.1.0/24」のことも含んでいますので、より大きな範囲指定をしています。
このルーティングテーブルで書かれるエントリのネットワークは必ず存在しているという必要はなく、
あくまでも転送ルールにすぎません。

この大きな範囲のネットワークのかきかたをつきつめると「0.0.0.0 0.0.0.0」となります。
これは「全てのアドレス」を意味しているため、どのIPアドレスに送るにしてもこのエントリに該当するようになります。

実はホストとして使っているルーターに設定していたデフォルトゲートウェイの設定は、
デフォルトルートの設定となります。

```text
PC1#conf t
PC1(config)#ip route 0.0.0.0 0.0.0.0 10.0.1.1
PC1(config)#end
```

ルーティングテーブル

```text
10.0.0.0/8 is variably subnetted, 4 subnets, 2 masks
C        10.0.1.0/24 is directly connected, GigabitEthernet0/1
L        10.0.1.1/32 is directly connected, GigabitEthernet0/1
C        10.0.2.0/24 is directly connected, GigabitEthernet0/2
L        10.0.2.1/32 is directly connected, GigabitEthernet0/2

S 0.0.0.0/0 via 10.
```

詳しくは別ページで扱いますが、ルーティングテーブルのエントリは重複が許されていて、
重複している場合は「**最も優先度が高いエントリに従って転送をする**」というルールがあります。
上記で言えば「0.0.0.0/0」は全てのネットワークのことなので、
「10.0.1.0/24」や「10.0.2.0/24」も含まれてしまうため重複しているといえます。

ただ、「10.0.2.0/24」のエントリは「0.0.0.0/0」より優先度が高いため、
10.0.2.0/24宛の通信は「10.0.2.0/24」のエントリに従って転送されます。
一方、10.0.3.0/24宛の通信は条件に合致するのは「0.0.0.0/0」だけなので、このエントリに従って転送されます。

家庭用のブロードバンドルーターは実はこのデフォルトルートだけを持っています。
本来のルーターは様々なネットワークに接続してルーティングテーブルのエントリに従って複雑な転送ルールに従って転送をしますが、
ブロードバンドルーターは自分が直接接続する家庭内のネットワーク及びサービスプロバイダー側のネットワークのアドレス以外は、
全てサービスプロバイダーのルーターに転送をします。

一般的な家庭にはインターネットへの接続口がサービスプロバイダーしかなく、家のネットワークも1つしかありません。
そのため、全てをサービスプロバイダーのルーターに任せるという動きで十分なのです。

![image](./0010_image/01.png)


## 経路集約

経路集約はネットワークの設計に関わる非常に重要な概念です。

経路集約は「連続した小さな複数のネットワーク」を「大きな一つのネットワーク」として外に見せるテクニックです。
これを使うことでルーティングテーブルに記載されるエントリの数が減らせるので、ネットワークを管理しやすくなります。
ただ、「連続した」とあるようにネットワークの設計をする際にレンジが近いネットワークアドレスを固める必要があります。

![image](./0010_image/01.png)

たとえば上記の図は複数の支店がある会社のネットワークの設計です。
各支店のアドレスは「10.1.0.0/16」「10.2.0.0/16」「10.3.0.0/16」などと大まかに区切られており、
支店の中でそのアドレスをやりくりしてネットワークを構築しています。

このような構成を取ると学習する経路情報は「支店間のルータは各支店の/16のネットワーク」
「各支店内のルーターは各支店内の細かいルートで、10.0.0.0/8は支店間のルーターに全て任せる」とできます。
このような構成を取るメリットはまず第一に分かりやすいものとなることがあげられます。
また、全てのルーターが組織内の全ての経路情報の全てを学習する必要がなくなります。

ネットワークの障害は複雑な構成なネットワークで機器が故障したり設定変更をした際に発生することが多いので、
シンプルな綺麗な構成を作れば「障害発生確率が減る」「障害発生のインパクトが減る」「復旧にかかる時間が短くなる」といいことずくめです。

![image](./0010_image/01.png)

経路集約を実現するテクニックは様々ありますが、よく使われるのは
「全てを一つのルーティングプロトコルで実現する」
「集約する境界で別のルーティングプロトコルのプロセスを使う」
「集約されたルート間はスタティックルートで実現する」
あたりです。
昨今だと支店間をVPNで接続して、スタティックルートで本社と支店の間での経路情報を設定するというパターンが多いです。
支店間の間のデータのやりとりは一旦本社を経由します。

ここではOSPFの経路集約機能を使って、全てをOSPFで実現するという手法を扱います。

### OSPFの経路集約


### サンプル構成



## ルート再配送

スタティックルートや複数のルーティングプロトコルを同時に使っている環境では、
あるソースから学んだ経路を別のソースに対して伝播させることができます。
この経路情報を異なるプロセスに伝播させることを「**ルート再配送**」と呼びます。
ルート再配送はBGPやIGP-Aの経路情報をIGP-Bに流すといった使い方はもちろんですが、
複数のOSPFのプロセス間(OSPFのグループ1、グループ2)で再配布するといった使い方もできます。

ルート再配送が使われるよくあるシナリオとしては、
BGPで学んだ経路(その一部)をIGPに伝播させるというものです。
BGPを使う外部と接続するルーターが外の経路を学んだとしても、
内部のルーターがその経路を知らなければ組織内でのルーティングができません。
そのため、BGPで学んだ情報をIGPの経路情報に注入して組織内の他のルーターに知らせることで、
組織内でもルーティングできるようにします。
(なお、この逆の「IGPの経路情報をBGPに注入する」ということはあまり行いません。
社内のグローバルIPのネットワーク情報を自動で外に知らせるということはせず、
BGPの設定でどの情報を外にアドバタイズするかということをきちんと設定します。)

他には組織の中にもいくつかのネットワーク管理グループが分かれていて、
そのグループ間で経路情報をやりとりしなければいけないといったシナリオでも利用されます。
社員数数万人規模の企業の複雑なネットワークを一つのOSPFのネットワークだけで完結させることは難しいですし、
企業Aが企業Bを買収した際のネットワークの接続といったシナリオでも必要となります。

なお、特別な理由なく組織内でルート再配送を利用することは避けてください。
ネットワークの複雑性が増すため管理しにくくなり、トラブルの原因となります。
