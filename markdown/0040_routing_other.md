# ルーティングその他

## 経路選択アルゴリズム

ルーティングテーブルにおいて「0.0.0.0/0」のデフォルトルートより、
宛先「10.0.0.100」は「10.0.0.0/8」の経路が優先されます。
このようにルーティングテーブルのエントリには優先度があり、
複数の経路の選択肢がある場合は最も優先度が高いものが選ばれます。

経路選択の優先度は以下の順序で決まります。

0. プレフィックス長の比較
0. AD値の比較
0. メトリックの比較

プレフィックス長の比較で優先度が同じであれば、AD値の比較に移る。
AD値の比較でも優先度が同じであればメトリックの比較をするという流れです。
メトリックも同じであった場合にどうなるかはプロトコル及び設定次第ですが、
一般的にはどれか一つのルートを使うか、ロードバランス(全て使う)するかのどちらかです。

それぞれの比較方式について説明します。

### プレフィックス長の比較

経路選択においていちばん重要なルールは「経路がより詳細に指定されているエントリを優先する」というものです。
具体的にはサブネットマスクの長さ(プレフィックス長)が長いものを、短いものより優先するということです。
「10.1.0.0/16」のネットワークへのルーティングは「10.0.0.0/8」よりも「10.1.0.0/16」のエントリを優先します。

![image](./0010_image/01.png)

実際にスタティックルートとTracerouteを使って、この動きを確認します。


```text
ルーティングテーブルの表示
```

```text
Tracerouteの表示
```

### AD値の比較

経路学習には様々な手法やプロトコルがあります。
たとえば管理者が手動で設定するスタティックルートや、OSPFによる自動学習などです。

これらの経路の学習元(ソース)には信頼性が設定されており、
それは「**AD値(Administrative Distance)**」と呼ばれています。
スタティックルートにもOSPFにもAD値が設定されており、
同じ経路を複数のソースから学習していた際は、ソースのAD値を比較することでどのルートを使うかを決めます。
AD値は「**値が低いものが優先される**」というルールがあります。

CiscoのルーターにおけるデフォルトのAD値は以下のようになっています。
学んでいないプロトコルなどもあるので知らないものは無視してもらって構いませんが、
今まで学んだものだと「直接接続されるネットワーク」「スタティックルート」「OSPF」という順で経路を選択することがわかります。
なお、AD値の比較よりプレフィックス長の比較の優先度が高いため、
より細かい経路を学習してしまうと直接接続しているネットワークあての通信だったとしても、
パケットが他のネットワークに転送されてしまうといったことは発生します。

```text
接続済み	0
スタティック	1
eBGP	20
EIGRP（内部）	90
IGRP	100
OSPF	110
IS-IS	115
RIP	120
EIGRP（外部）	170
iBGP	200
EIGRP サマリー ルート	5
```

このデフォルトのAD値には「自動学習したものより自分で設定したものを優先する」といった常識的なルールが適用されています。
EIGRPというCisco独自のルーティングプロトコルをOSPFより優先するといった点もありますが、
組織内で複数のルーティングプロトコルを同時に動かすことは滅多にないため考慮は不要かと思います。
ただ、BGPは他のルーティングプロトコルと共用されることがあるため、若干注意が必要です。

![image](./0010_image/01.png)

```text
ルーティングテーブルの表示
```

```text
Tracerouteの表示
```

なお、各ソースのAD値は変更することができます。
スタティックルートは各エントリごとにAD値を調整することができるので、
「ルーティングプロトコルにトラブルが起きて経路情報を失った際はここに転送する」といった使い方をまれにします。

AD値を意識しなければいけないようなネットワークを構築することは可能な限り避けて下さい。
複数のソースで複雑なエントリを構築しているということは、理解しにくいネットワーク構造になっている可能性が高いです。


### メトリックの比較

「**メトリック**」は各ルーティングプロトコルの経路選択のルールです。
各ルーティングプロトコルごとに異なるメトリックのルールを持っているため、OSPFのメトリックはOSPFのなかだけで使われます。
他のプロトコルとの比較はメトリックではなくAD値で行われます。

メトリックは特定のルーティングプロトコルで組織内で運用する際に重要な役割を果たします。
複数のルーターが階層的に接続されている状況では、あるネットワークに辿り着く経路が複数ある場合があります。
メトリックはそういった際に「この経路が良さそうだから、これを使う」といったことを判断する仕組みです。

たとえば以下の図では左側のネットワークから右側のネットワークまで辿り着く経路が上下にあります。
プレフィックス長も同じで、AD値も共にOSPFなので同じです。

![image](./0010_image/01.png)

ただ、宛先までに辿り着くホップ数が異なっています。
OSPFのメトリックの細かい計算方法は割愛しますが、
「高帯域の経路を優先する」「もし同じ帯域ならホップ数が短いものを優先する」というルールを覚えておけば十分です。
今回の場合は経路の帯域が全て同一ですので、ホップ数が短い上側の経路を選択します。
もし上側の経路の帯域が下側より少ない(通常は1/10になる)場合は、下側のルートを選びます。

```text
ルーティングテーブルの表示
```

```text
Tracerouteの表示
```

このように複数の経路で宛先にネットワークにいける場合は片側の経路が障害などで使えなくなったとしても、
もう片側の経路を使うことができます。


## ルート再配送

スタティックルートや複数のルーティングプロトコルを同時に使っている環境では、
あるソースから学んだ経路を別のソースに対して伝播させることができます。
この経路情報を異なるプロセスに伝播させることを「**ルート再配送**」と呼びます。
ルート再配送はスタティックルートやEIGRPの経路情報をOSPFに流すといった使い方はもちろんですが、
複数のOSPFのプロセス間(OSPFのグループ1、グループ2)で経路情報をやりとりするといった使い方もできます。

ルート再配送が使われるよくあるシナリオとしては、
組織の中にもいくつかのネットワーク管理グループが分かれていて、
そのグループ間で経路情報をやりとりしなければいけないといったものです。
もしくは組織間で使われるBGPで学んだ経路情報を、組織内でOSPFなどとして伝播するといったものです。

![image](./0010_image/01.png)

なお、ルート再配送は積極的に利用するものではありません。
使わずに済むのであれば、ネットワークの設計を変更するなどして綺麗な構成にすることを推奨します。
たとえば後述する経路集約をすることを前提としてネットワークを設計すれば、
組織内の細かいルートを再配送する必要はなくなり、おおまかなルートでグループ間の経路情報を定義できます。

### OSPFのルート再配送

### サンプル



## 経路集約

経路集約はネットワークの設計に関わる非常に重要な概念です。

経路集約は「連続した小さな複数のネットワーク」を「大きな一つのネットワーク」として外に見せるテクニックです。
これを使うことでルーティングテーブルに記載されるエントリの数が減らせるので、ネットワークを管理しやすくなります。
ただ、「連続した」とあるようにネットワークの設計をする際にレンジが近いネットワークアドレスを固める必要があります。

![image](./0010_image/01.png)

たとえば上記の図は複数の支店がある会社のネットワークの設計です。
各支店のアドレスは「10.1.0.0/16」「10.2.0.0/16」「10.3.0.0/16」などと大まかに区切られており、
支店の中でそのアドレスをやりくりしてネットワークを構築しています。

このような構成を取ると学習する経路情報は「支店間のルータは各支店の/16のネットワーク」
「各支店内のルーターは各支店内の細かいルートで、10.0.0.0/8は支店間のルーターに全て任せる」とできます。
このような構成を取るメリットはまず第一に分かりやすいものとなることがあげられます。
また、全てのルーターが組織内の全ての経路情報の全てを学習する必要がなくなります。

ネットワークの障害は複雑な構成なネットワークで機器が故障したり設定変更をした際に発生することが多いので、
シンプルな綺麗な構成を作れば「障害発生確率が減る」「障害発生のインパクトが減る」「復旧にかかる時間が短くなる」といいことずくめです。

![image](./0010_image/01.png)

経路集約を実現するテクニックは様々ありますが、よく使われるのは
「全てを一つのルーティングプロトコルで実現する」
「集約する境界で別のルーティングプロトコルのプロセスを使う」
「集約されたルート間はスタティックルートで実現する」
あたりです。
昨今だと支店間をVPNで接続して、スタティックルートで本社と支店の間での経路情報を設定するというパターンが多いです。
支店間の間のデータのやりとりは一旦本社を経由します。

ここではOSPFの経路集約機能を使って、全てをOSPFで実現するという手法を扱います。

### OSPFの経路集約


### サンプル構成




## デフォルトルート

ルーティングテーブルにエントリがない宛先へのパケットはルーターで破棄されてしまいます。
「**デフォルトルート**」はデフォルトゲートウェイのルーター版であり、
特別に指定されていない宛先は全てこのアドレスに転送をするというものです。

デフォルトルートの設定をすることで、
ルーティングテーブルのエントリに「全てのネットワークの宛先はここに送る」というものを加えます。
受け取ったパケットは全てそのエントリに該当するので、
宛先不明として破棄されるパケットがなくなります。

全てのアドレスが該当するネットワークアドレスは「**0.0.0.0/0**」となります。
サブネットマスクで「255.255.255.0」とすると「/24」で256ホストのネットワークとなり、
「255.255.0.0」とすると「/16」で「256 x 256」ホストのネットワークを示します。
どんどんサブネットを小さくしていくと、「0.0.0.0」となり「256 x 256 x 256 x 256」のホストのネットワークを示すため、
つまりは世界中のホスト全てを含む巨大なネットワークを示します。

ルーティングテーブルに書かれるエントリは必ずしも現実に存在するネットワークである必要はなく、
あくまでも転送ルールにすぎません。
「0.0.0.0/0」というネットワークはインターネットには存在しませんが、
ルーティングテーブルのエントリとしては問題ありません。

「10.0.0.0/16」は「10.0.1.0/24」のことも含んでいますので、より大きな範囲指定をしています。
このルーティングテーブルで書かれるエントリのネットワークは必ず存在しているという必要はなく、
あくまでも転送ルールにすぎません。

この大きな範囲のネットワークのかきかたをつきつめると「0.0.0.0 0.0.0.0」となります。
これは「全てのアドレス」を意味しているため、どのIPアドレスに送るにしてもこのエントリに該当するようになります。

実はホストとして使っているルーターに設定していたデフォルトゲートウェイの設定は、
デフォルトルートの設定となります。

```text
PC1#conf t
PC1(config)#ip route 0.0.0.0 0.0.0.0 10.0.1.1
PC1(config)#end
```

ルーティングテーブル

```text
10.0.0.0/8 is variably subnetted, 4 subnets, 2 masks
C        10.0.1.0/24 is directly connected, GigabitEthernet0/1
L        10.0.1.1/32 is directly connected, GigabitEthernet0/1
C        10.0.2.0/24 is directly connected, GigabitEthernet0/2
L        10.0.2.1/32 is directly connected, GigabitEthernet0/2

S 0.0.0.0/0 via 10.
```

詳しくは別ページで扱いますが、ルーティングテーブルのエントリは重複が許されていて、
重複している場合は「**最も優先度が高いエントリに従って転送をする**」というルールがあります。
上記で言えば「0.0.0.0/0」は全てのネットワークのことなので、
「10.0.1.0/24」や「10.0.2.0/24」も含まれてしまうため重複しているといえます。

ただ、「10.0.2.0/24」のエントリは「0.0.0.0/0」より優先度が高いため、
10.0.2.0/24宛の通信は「10.0.2.0/24」のエントリに従って転送されます。
一方、10.0.3.0/24宛の通信は条件に合致するのは「0.0.0.0/0」だけなので、このエントリに従って転送されます。

家庭用のブロードバンドルーターは実はこのデフォルトルートだけを持っています。
本来のルーターは様々なネットワークに接続してルーティングテーブルのエントリに従って複雑な転送ルールに従って転送をしますが、
ブロードバンドルーターは自分が直接接続する家庭内のネットワーク及びサービスプロバイダー側のネットワークのアドレス以外は、
全てサービスプロバイダーのルーターに転送をします。

一般的な家庭にはインターネットへの接続口がサービスプロバイダーしかなく、家のネットワークも1つしかありません。
そのため、全てをサービスプロバイダーのルーターに任せるという動きで十分なのです。

![image](./0010_image/01.png)
