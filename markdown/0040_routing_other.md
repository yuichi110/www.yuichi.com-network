# ルーティングその他

## 概要


## 経路選択アルゴリズム

ルーティングテーブルに格納されようとする経路情報は重複していたりする場合があります。
たとえば、以下の図のトポロジにおいて、
R1はスタティックルートで「10.2.0.0/16へは10.0.0.2(R2)を経由する」という設定をされたうえで、
OSPFで他のルーターから「10.2.0.0/16へは10.0.0.3(R3)を経由する」という情報を受け取るかもしれません。

![image](./0040_image/01.png)

このようなシナリオでどの経路を利用するかということはルーターの「**経路選択のアルゴリズム**」に依存します。
スタティックルートやルーティングプロトコルで学んだ経路情報がどのようにルーティングテーブルに反映されるか、
宛先にマッチするルーティングテーブルのエントリが複数ある場合にどれが選ばれるかというルールは厳密に決まっています。

細かな違いはあるかもしれませんが、経路選択のアルゴリズムはネットワーク機器のベンダーに大きく依存してはいません。
利用する経路情報はおおまかに以下の順序で決まります。

0. プレフィックス長(サブネットの値)の比較
0. AD値(どの学習方法を優先するか)の比較
0. メトリック(通信コスト)の比較

複数あるルーティングテーブルのエントリのうち、
最も宛先アドレスを正確に合致するエントリを選ぶというルールがあります。
具体的には192.168.1.102に対してパケットを転送する場合に、
「192.168.0.0/16はR2経由」「192.168.1.0/24はR3経由」というエントリが同時に存在していたとすると、
後者を優先してR3宛にパケットを転送します。
「正確に合致する」ということは「プレフィック(サブネットマスク)がより厳密」と言い換えられます。

次に経路学習のおおもとの信頼性に応じて、利用する経路情報を選択するというルールが適用されます。
たとえば、スタティックルートで「192.168.1.0/24はR2経由」と設定されており、
OSPFでも「192.168.1.0/24はR3経由」と学習しているとしましょう。
このとき、スタティックルートの情報はOSPFよりも信頼されるとルーターは判断するため、
「192.168.1.0/24はR2経由」というエントリを採用して転送します。
どの学習元の情報の信頼性が高いかということはAD値というパラメーターで管理されています。
ルーティングテーブルには一番信頼できる情報源のエントリしか存在しません。

最後のルールがメトリックです。
OSPFで「192.168.1.0/24はR2経由」「192.168.1.0/24はR3経由」という情報を学んだとします。
2つの経路情報は、ともに同じ宛先に対するものでプレフィックスも全く同じです。
学習元はともにOSPFであるため信頼性も同じです。
このような状況では通信コストが低い最短経路を利用します。
その判断に用いられるのがメトリックと呼ばれる情報です。
メトリックの基準はルーティングプロトコルにより異なり、
RIPではホップ数という単純なものですが、OSPFでは途中の経路の帯域が用いられます。
ルーティングテーブルにはメトリックが最小(最もコストが低い)のエントリしか存在しません。

メトリックも同一の複数経路があった場合にどうなるかは機器の種類やルーティングプロトコル、設定により異なります。
どれか一つを使う場合もあれば、複数の経路を同時に使ってロードバランスすることもあります。

以下でこれらのルールの詳細について順に扱います。

### プレフィックス長の比較

経路選択においていちばん重要なルールは「経路がより詳細に指定されているエントリを優先する」というものです。
具体的には宛先IPに該当する複数のエントリがあった場合は、
「**サブネットマスクの長さ(プレフィックス長)が長いエントリを、短いエントリより優先する**」ということです。
どのような信頼できない情報元であっても、どれほど宛先までの通信コストが大きかろうと、
転送にはより詳細な経路のエントリが選択されます。

たとえばスタティックルートで設定した「192.168.0.0/16は10.0.0.2経由」というエントリと、
OSPFで学習した「192.168.1.0/24は10.0.0.3経由」というエントリがあるとします。
このとき、「192.168.1.102」宛のパケットは上記2つのエントリのどちらにも合致します。
ただ、プレフィックス長「/24」は宛先アドレスのうち24bitにマッチしているのに対し、
「/16」は16bitにしかマッチしていません。

よりマッチしているほうが、より正確に宛先アドレスに合致しているエントリであるため、
宛先「192.168.1.102」宛のパケットには「192.168.1.0/24は10.0.0.3経由」というOSPFで学習したエントリが採用され、
パケットは10.0.0.3に転送されます。

![image](./0040_image/02.png)

なお、プレフィックス長が長いというのは、合致するエントリの数が少ないということでもあります。
たとえば「192.168.2.103」宛のパケットを受け取った場合は、
「192.168.1.0/24は10.0.0.3経由」というエントリはマッチしないので、
「192.168.0.0/16は10.0.0.2経由」というエントリが採用されます。

実際にTracerouteを使って、この動きを確認します。

```text
ルーティングテーブルの表示
```

```text
Tracerouteの表示
```


### AD値の比較

経路学習には様々な手法やプロトコルがあります。
たとえば管理者が手動で設定するスタティックルートや、OSPFによる自動学習などです。
そのような状況では同一の宛先に対する経路情報を複数のソースから学ぶ可能性があり、
スタティックルートでは「192.168.1.0/24は10.0.0.2経由」とあり、
OSPFでは「192.168.1.0/24は10.0.0.3経由」といった異なる状況になることもありえます。

そのような状況下でどのソースの経路情報を採用してルーティングテーブルのエントリにするかを判断するため、
経路の学習元には信頼性が設定されており、
それは「**AD値(Administrative Distance)**」と呼ばれています。
AD値は「**値が低いものが優先される**」というルールがあります。
同一の経路情報を複数の学習元から学習していると、
ルーティングテーブルのエントリには最も信頼されるエントリ(つまりAD値が低いもの)しかのりません。

CiscoのルーターにおけるデフォルトのAD値は以下のようになっています。
学んでいないプロトコルなどもあるので知らないものは無視してもらって構いませんが、
今まで学んだものだと「直接接続されるネットワーク」「スタティックルート」「OSPF」という順で経路を選択することがわかります。

```text
接続済み	0
スタティック	1
eBGP	20
EIGRP（内部）	90
IGRP	100
OSPF	110
IS-IS	115
RIP	120
EIGRP（外部）	170
iBGP	200
EIGRP サマリー ルート	5
```

このデフォルトのAD値には「自動学習したものより自分で設定したものを優先する」といった常識的なルールが適用されています。
EIGRPというCisco独自のルーティングプロトコルをOSPFより優先するといった点もありますが、
組織内で複数のルーティングプロトコルを同時に動かすことは滅多にないため考慮は不要かと思います。
ただ、BGPは他のルーティングプロトコルと共用されることがあるため、若干注意が必要です。

このAD値を考慮すると、スタティックルートで学んだ「192.168.1.0/24は10.0.0.2経由」という情報は、
OSPFで学んだ「192.168.1.0/24は10.0.0.3経由」という情報よりも信頼されることがわかります。
そのため、ルーティングテーブルのエントリには「192.168.1.0/24は10.0.0.2経由」と記載されます。

![image](./0040_image/03.png)

```text
ルーティングテーブルの表示
```

```text
Tracerouteの表示
```

AD値を意識しなければいけないようなネットワークを構築することは可能な限り避けて下さい。
複数のソースで複雑なエントリを構築しているということは、
理解しにくいネットワーク構造になっている可能性が高いです。


### メトリックの比較

「**メトリック**」は各ルーティングプロトコル内での経路選択のルールです。

組織内で使われるIGPのプロトコル群では考え方こそ違うものの最も適した経路を選ぶようにメトリックが決められています。
RIPであれば目的地までのホップ数(ルーティングの回数)であり、
他のプロトコルは帯域幅を優先して同じであれば短いものを選ぶというルールです。
組織感で使われるEGPのプロトコル、つまりBGPは最短経路ではなく組織感の調整で決められた経路を使うようにメトリックを設定できます。
IGPに比べるとかなり複雑なメトリックが利用されます。

メトリックはそれぞれのプロトコル内で使われるものなので、
RIPのメトリックはOSPFにとっては意味はありません。
同一のプロトコルが知る「同一の宛先への経路」が複数ある場合に、
メトリックを使ってどれを利用するか決めます。

たとえばOSPFが「192.168.1.0/24は10.0.0.2経由」「192.168.1.0/24は10.0.0.3経由」という2つを学んでいるとします。
プレフィックス値は同一であり、ともにAD値はOSPFであるため、これだけでは経路の優劣はつけられません。
ただ、以下の図のような構成ではR1から見れば、192.168.1.0/24のネットワークにたどり着くには10.0.0.3経由よりも、
10.0.0.2経由のほうが近いです。
全てのリンクの速度が同じだとすれば10.0.0.2経由の経路のメトリックが小さくなるため、
「192.168.1.0/24は10.0.0.2経由」がOSPFが持つ経路情報として採用されます。

![image](./0040_image/04.png)

RIP以外のIGPプロトコルにおいては「経路上の最小帯域幅が最も大きい経路を選ぶ」というのが基本ルールで、
帯域幅に違いがなければホップ数(通過するルーターの数。L2ではなくL3なのでスイッチは含まない)が最も近い経路を選びます。
最小帯域幅が基準になるので、経路の一部が10Gであっても、間に100Mがあれば、それは100Mの経路です。
その100Mの経路よりは「経路上に10Gはなくても、全てが1Gとなっている経路」が一般的には採用されます。

```text
ルーティングテーブルの表示
```

```text
Tracerouteの表示
```


## デフォルトルート

YahooやGoogleのサイトにアクセスする通信は、組織内や組織外のルーターで目的地まで転送される必要があります。
ただ、ルーターは「ルーティングテーブルにエントリがない宛先へのパケットは破棄する」というルールがあるため、
転送できるエントリがルーターにないとそういったサイトには通信できなくなります。

インターネット上に存在するサービスは数え切れないほどありますので、
それら向けのエントリを個別にルーターに設定するということは不可能です。
そのため、自宅のルーターが宅内通信以外を全てISP側のデフォルトゲートウェイに投げるように、
組織内のルーターも「組織外への通信は全て上位のルーターに転送する」という設定を行います。
PCにデフォルトゲートウェイの設定をするのと同じように、
ルーターにも「**デフォルトルート**」と呼ばれるエントリを作成し、それを上位ルーターに向けます。

ルーティングテーブルのエントリで「10.0.0.0/8」は32bit長のアドレスの前半8bitが合致するかを調べ、
「10.0.0.0/16」は前半16bitを調べます。
これと同じように「0.0.0.0/0」とすれば、前半0bitを調べます。
0bitを調べるということは、つまり何も調べないということですので、全てのアドレスがこれに合致します。
ルーターのエントリとして「**0.0.0.0/0**」を作れば、それがデフォルトルートとして働きます。

インターネットに繋がるルーターの下に複数のルーターが存在するというシンプルな構成だと、
デフォルトルートは以下の図のように設定されます。

![image](./0040_image/05.png)

ルーターR3などの下にもPCといったホストが存在し、
それらはデフォルトゲートウェイとして上位のルーターを設定しています。
ホストからの通信を受け取ったルーターは、それが組織内の通信であれば適切なルーターに転送し、
そうでなければエントリ「0.0.0.0/0」に合致するため、インターネットに接続するルーターR1に転送します。
R1も組織内への通信でなければエントリ「0.0.0.0/0」に従ってISPにパケットを転送します。
その際に送信元IPはNATを使ってグローバルIPに変換されます。

インターネットのコアにあるISPはインターネット内の経路情報を持つため、
目的地(例えばYahoo)宛のパケットを適切にルーティングして目的地に届け、
帰りのパケットも適切にルーティングして自社にまで届けます。

組織の中に存在するルーターの数が多くなければデフォルトルートをスタティックルートで書いてもよいですが、
複雑なネットワークの場合はOSPFなどのIGPを使ってデフォルトルートを上流から下流にアドバタイズするのが効率がよいです。
IGPを使ってアドバタイズすれば機器に障害が発生しても自動で経路の切り替えができます。

OSPFでデフォルトルートをアドバタイズするには「**default-information originate**」
コマンドをOSPFコンフィギュレーションモードで発行します。
このコマンドのオプションはいくつかありますが、
「default-information originate always」とすればデフォルトルートをルーティングテーブルに保持していなくてもアドバタイズします。
このオプションがなければ「0.0.0.0/0」がエントリに存在しないと、それをOSPFでアドバタイズしません。
このオプションの使い所としてはデフォルトルートを使った出口が一つしか無いのであれば、
alwaysオプションを使う。
出口が複数あればmetricオプションで出口の優劣を決めて、
alwaysオプションなしでアドバタイズするといったものがあげられます。
後者は障害でデフォルトルートを失った場合にアドバタイズしなくなるので、
インターネット側で障害が起きた場合に冗長経路に切り替えることが実現できます。

上記の構成を設定してデフォルトルートのエントリを確認してみます。
本来はNAT及びグローバルIPアドレスの設定をすべきでしょうが、NATは別ページにて説明するためここでは省きます。
ISP側から組織側へはスタティックルートを設定しておきます。

```text

```

ルーティングテーブル

```text

```

なお、この設定だとインターネットの境界であるR1ではデフォルトルートに従って個別のエントリにないプライベートアドレス(例えば10.5.0.0/16)も、
インターネット側に流れてしまうという問題があります。
インターネット側のルーターISPは別組織からプライベートアドレス宛のパケットが送られてきても破棄するので、送るだけ帯域の無駄遣いです。

こういった問題は境界にあるR1にてプライベートアドレス宛の通信を「**null0**」という破棄するインタフェースに転送するというテクニックで回避します。
また、他の組織からプライベートアドレス宛の通信が来ても処理しないように、
そういったインタフェースではプライベートIP宛の通信をドロップするようなACL(別ベージで扱います)やFirewallの設定をします。



## 経路集約

「**経路集約**」は「小さな複数のネットワーク」を「大きな一つのネットワーク」として、
他のルーターに見せるテクニックです。
スタティックルートで手動で設定することもあれば、
OSPFなどのIGPの機能で実現することもあります。

![image](./0040_image/06.png)

上記の図では10.1.1.0/24と10.1.2.0/24のネットワークを10.1.0.0/16に集約しています。
10.1.0.0/16は10.1.1.0/24も10.1.2.0/24も含んでいるため、
小さな2つの経路情報をそれを含む大きな経路情報に集約できます。
集約するネットワークは集約されるネットワークをカバーする必要があるため、
10.2.1.0/24を10.1.0.0/16の集約に加えることはできません。

同様に10.0.0.0/16と10.1.0.0/16、10.2.0.0/16は10.0.0.0/8に集約することができます。
10.3.0.0/16などは存在しない経路情報ですが、これも10.0.0.0/8に含まれるためルーティングされるようになります。
ただ、最終的に宛先がなくなった段階でドロップされてしまいます。

経路集約を行うことで、
ルーティングテーブルに多数存在する小さなネットワークのエントリを、
少数の大きなネットワークのエントリにすることができます。
100個の細かく区切られたエントリを管理するよりも、
10個の大きなエントリを管理するほうがネットワークの構成が把握しやすくなります。


### 設計

経路集約するアドレスは経路集約されるアドレスを含んでいる必要があるため、
ネットワークの設計をする際にレンジが近いネットワークアドレスを固める必要があります。

ネットワークのトポロジ上のあるエリアを10.1.0.0/16に集約したいと思ったら、
そのエリアは10.1.0.0/16を細かく区切った10.1.1.0/24や10.1.2.0/24で構成されている必要があります。
ここに集約できない10.99.1.0/24などが存在していると、
集約しようとしても10.99.1.0/24のエントリは残り続けてしまいます。

たとえば上記の図は複数の支店(拠点)がある会社のネットワークの設計をするとしましょう。
各支店の間は拠点間ネットワークで接続して、支店間の通信は全てこれを通ります。

それぞれの拠点のアドレス設計を集約を前提に設計すれば、以下の図のような構成が作れます。

![image](./0040_image/07.png)

東京のネットワークは全て10.1.0.0/16のサブネットで構成されており、
大阪のネットワークは全て10.2.0.0/16に含まれています。
各拠点内のルーティングはOSPFで実現していますが、
拠点間はスタティックルートでルーティングしています。

経路集約をしなければ大阪のルーターのルーティングテーブルのエントリには東京のネットワークの全ての経路情報(10.1.0.0/24, 10.1.1.0/24, 10.1.2.0/24)が存在するはずです。
ただ、「東京のネットワークは全て10.1.0.0/16」に含まれるというルールが存在すれば、
大阪のルーターは10.1.1.101だろうが、10.99.0.101(実際は存在しない)だろうが、
とりあえず東京に送ればいいという単純なエントリのもとで運用できます。
そのため、必要なエントリは10.1.0.0/16のひとつだけとなります。

集約をすれば障害発生時の問題が局所的に収められたり、
経路変更の収束速度なども向上するといった利点があります。
上記の図では東京の10.1.0.0/16内の障害は大阪には隠されているため、
東京内のみでの経路収束で問題が直ります。
もし集約されていなけば、大阪のルーターまで東京側のトラブルの収束に巻き込まれてしまうため、
収束時間が伸びる傾向があります。

今回のサンプルのような規模であれば集約しなくても対処ができるかもしれませんが、
数十拠点が存在してそれぞれの拠点が100個のネットワークを持つような構成だと、
経路集約しなければルーティングテーブルのエントリが数千に及びます。
綺麗にアドレス体系が定められておらず、
たとえば「新規に作成するネットワークには順に10.X.Y.0/24のアドレスを与える」というルールでネットワークが構築されていれば、
どのアドレスがどの拠点にあるのか検討がつかなくなります。
そのような状況で障害が発生すれば、カオスのような状態になります。

、不適切な設計のネットワークで経路集約をすると、飛び地が発生することがあります。
たとえば大阪のなかに10.1.3.99.0/24のネットワークが存在すれば、
「東京に10.1.0.0/16を転送する、ただし10.1.99.0/24に限っては大阪に転送する」という動きになります。
ルーティングアルゴリズムのプレフィックスに関するルールがあるためルーティングは問題なく実施できますが、
そのような状況は望ましくありません。

ネットワークの設計をする場合は集約を前提とすることが必要です。
コアとなるネットワーク(今回でいえば拠点間ネットワーク)に、
どのようにネットワークを接続していくかをルールを決めて、
階層構造のネットワークを構築すれば難しいことはありません。


経路集約を実現するテクニックは様々ありますが、
大きく分類すると今回のようなスタティックルートを使うというものと、
ルーティングプロトコルの機能を使うものです。

集約されるエリアごとの接続がシンプルなのであれば、
スタティックルートで十分です。
エリアごとの接続が複雑なのであればルーティングプロトコルを使います。


### スタティックルートを使った経路集約

先程の東京拠点と大阪拠点の構成をスタティックルートで集約するサンプルを示します。
拠点間ネットワークがスタティックルーティングで実現されています。

```text
config
```


### OSPFを使った経路集約

東京拠点と大阪拠点の間をスタティックルーティングではなく、OSPFで接続します。
OSPFの「**エリア**」及び「**エリアごとの経路集約**」という機能を使います。

![image](./0040_image/08.png)

```text
config
```


## ルート再配送

スタティックルートや複数のルーティングプロトコルを同時に使っている環境では、
あるソースから学んだ経路を別のソースに対して伝播させることができます。
この「経路情報を異なるプロセスに伝播させること」を「**ルート再配送**」と呼びます。

ルート再配送はIGP-Aの経路情報をIGP-Bに流すといった使い方はもちろんですが、
複数のOSPFのプロセス間(OSPFのグループ1、グループ2)で再配布するといった使い方もできます。

ルート再配送が使われるよくあるシナリオとしては、
BGP(異なる組織と経路情報を交換するためのルーティングプロトコル)で学んだ経路情報を組織内のルーティングプロトコルであるIGPに伝播させるというものです。
BGPを利用する外部と接続するルーターが外の経路を学んだとしても、
内部のルーターがその経路を知らなければ組織内でのルーティングができません。
そのため、BGPで学んだ情報をIGPの経路情報に注入して組織内の他のルーターに知らせることで、
組織内でもルーティングできるようにします。

他には組織の中にもいくつかのネットワーク管理グループが分かれていて、
そのグループ間で経路情報をやりとりしなければいけないといったシナリオでも利用されます。
社員数数万人規模の企業の複雑なネットワークを一つのOSPFのネットワークだけで完結させることは難しいですし、
企業Aが企業Bを買収した際のネットワークの接続といったシナリオでも必要となります。

また、スタティックルートの経路情報をIGPに流すということもよくおこなわれます。
先に扱った経路集約の例ですと、東京側の境界のルーターが大阪への集約ルートをOSPFに伝播させるといった使い方です。
外への出口がひとつしかないのであればデフォルトルートを伝播させれば構いませんが、
宛先ごとに出口が異なるというシナリオでは個別ルートを伝播させる必要があります。


### スタティックルートをOSPFに再配送

ルート再配送はどのソースの経路情報を何に注入するかによって、やりかたが若干異なってきます。
また、全ての経路情報を注入するか、特定の経路情報のみを注入するかによっても、やりかたが異なります。
ここでは最もシンプルなスタティックルートの経路情報をOSPFに注入するというシナリオで設定を行います。

構成は以下の図のようになります。
経路集約に使った構成を少し変えて、別拠点への通信とインターネットへの通信で出口が異なっています。

![image](./0040_image/09.png)

ルーターR1は別拠点のネットワークに通信するためにR2へパケットを転送します。
それにはR2から別拠点の経路情報を受け取る必要があります。

R2は別拠点の経路情報(10.2.0.0/16)をOSPFで学んでいるわけではなく、
スタティックルートで持っています。
そのため、そのルートは何もしなければOSPFで隣接ルーターであるR1にアドバタイズされることはありません。
この経路をアドバタイズするために、R2はスタティックルートの経路情報をOSPFにルート再配送で注入します。
そのスタティックルートの経路情報がOSPFの管理下になるため、それがR1にアドバタイズされます。

これと同様にインターネットに繋がるルーターR4は、
インターネットに出るためのデフォルトルートとなる0.0.0.0/0のスタティックルートの経路情報を再配送でOSPFに注入します。
ここは再配送ではなく、OSPFのデフォルトルート生成機能を使っても構いません。
これらの設定をすることで、ルーターR1は別拠点の経路情報(10.2.0.0/16)及び、デフォルトルートを学んで、
正しい宛先にパケットを転送できるようになります。

```text
config
```

経路再配送も可能な限り経路集約をすべきです。
OSPFにとって外のルートの詳細を全て細かく把握することは望ましくありません。
外の経路情報でルーティングテーブルが埋め尽くされたり、
外の構成変更やトラブルが発生するたびにOSPFの内側でその情報が頻繁に更新されるのは避けるべきです。
どのような使い方をするにしても、正しいネットワークの設計をして、
ルーティングテーブルをシンプルに保つ必要があります。