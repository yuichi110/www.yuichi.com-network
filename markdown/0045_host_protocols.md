# ホストが利用するネットワークプロトコル

## 概要


## パケット転送以外のネットワーク技術

今まで学んできた同一ネットワーク内のL2転送及び異なるネットワーク間のL3転送は、
パケットを送信元から宛先に転送していくための根幹的な仕組みです。

ただ、自分がどのようにPCやスマホを使っているか想像して頂くと
「IPアドレスを直接設定する」「通信相手をIPで指定する」といったことは必ずしもしていないことが分かります。
PCをwifiに繋げれば勝手にネットワークに繋がるようになりますし、
ブラウザでwebサイトを見るときはIPアドレスではなくドメイン名(yahoo.co.jpなど)を指定します。

こういった機能を実現するにはパケット転送に関わるイーサネットやTCP/IPといった根幹的なプロトコルだけではなく、
ネットワークの利用者を手助けするようなプロトコルが必要となります。
より発展させた転送系のトピックを扱う前に、ユーザーに関わりの強いプロトコルについて扱うこととします。


## DHCP

自分が管理しないネットワークの構成は分からないことが一般的です。
自宅ならまだしも、IT部署でなければ会社のネットワークすら把握しておらず、
ホテルやカフェに至っては検討もつかないはずです。

そのような構成が分からないネットワークにケーブルやwifiで接続し、
インターフェースにIPとサブネットマスク及びゲートウェイの設定をすることはできません。
多数のユーザーが利用する多くの環境ではユーザーにネットワークの設定をさせることはできず、
繋げただけでネットワークを利用できるようにする必要があります。

これをするのが「**DHCP(Dynamic Host Configuration Protocol)**」です。
ネットワーク上に「**DHCPサーバー**」と呼ばれるアドレス情報を配信するサーバーを設置し、
そこにインターフェースに「DHCPでアドレスを学習する(一般的なPCではこれがデフォルトになっている)」と設定したホストを接続すると、
ホストがアドレスを要求する「**DHCPクライアント**」として動作します。

DHCPクライアントはL2ブロードキャスト(同一ネットワーク上の全ての機器あてに送信する宛先MACアドレスを使用)で、
ネットワーク上に存在すると思っているDHCPサーバーに対して「ネットワークの設定を下さい」と依頼をします。
ブロードキャストですのでサーバーのアドレスを知らなくても、クライアントはサーバーまでリクエストを届けられます。
ただ、サーバーはブロードキャストの範囲となる同一ネットワーク上に存在している必要があります。

DHCPサーバーがネットワーク上に存在すれば、クライアントからのリクエストを受け取ります。
その内容を確認したサーバーはクライアントに対して「この設定を使って下さい」とDHCPレスポンス(応答)をかえします。
この応答の宛先はリクエストの送信元MACアドレスを見れば特定できるため、
クライアントに対してL2ユニキャストでを返します。

DHCPレスポンスを受け取ったクライアントはインターフェースに設定すればよい基本的なネットワーク情報(IPアドレス、
サブネットマスク、ゲートウェイのアドレス、ネームサーバーなど)が分かりますので、
それを受け取ったインターフェースに設定します。

![image](./0040_image/01.png)

に参加するホスト(

今までの設定ではホストとして使うルーターのインターフェースにIPやサブネットマスクを設定していましたが、
そのようなことはといった構成が分からないネットワークではできませんし、
自宅であったとしてもPCに詳しくない人は自分で設定ができません。
つまり、ネットワークのケーブルをさしたり、
wifiに参加するだけで勝手に適切なネットワークの設定がされる必要があるということです。


この依頼を受けたサーバーはクライアントに対して
クライアントがその設定をすれば、ネットワークに参加できるアドレスを自分のインターフェースに設定します。



サーバー側にはクライアントに渡す情報を事前に設定しておく必要があり、
「**DHCPプール**」と呼ばれるクライアント用に準備したアドレス範囲とサブネット、
及びデフォルトゲートウェイあたりは必須の設定になります。
これ以外にもDNSなどの情報も設定することが多いです。

サーバーとクライアントのやりとりには状態遷移がありますが、
トラブルが発生した場合以外では細かな流れを気にする必要はありません。

注意が必要なのはDHCPクライアントはアドレスが設定されるまでは、
IPでの通信ができないということです。
宛先が分からないDHCPサーバーへのリクエストはL2でのブロードキャストを利用しますので、
もしサーバーがクライアントが接続するネットワークに存在できなければ応答することができません。
(一つのDHCPサーバーで複数のネットワークをまかなうために「**DHCPリレー**」というDHCPリクエストを他のネットワークで処理する手法もあります)

## DNS

YahooやGoogleのウェブページにたいしてアクセスする際に「http://www.yahoo.co.jp」や「http://www.google.co.jp」と指定します。
この「http://」という箇所は接続するアプリケーションのプロトコルとしてhttpを使いますよという宣言ですので、
パケット転送というレベルではさほど重要ではありません。
その後ろの「www.yahoo.co.jp」や「www.google.co.jp」は「**ドメイン**」と呼ばれるもので、
インターネットの中にそのホストがどこにあるかという情報を示すものです。
つまり、ドメインがIPアドレスの代わりに使われているということです。

ドメインは人間にとってはIPアドレスよりも認識しやすいものです。
IPアドレスは単なる数値の羅列に過ぎませんが、ドメインにサービス名や会社名などが使われると簡単に入力することができます。

ただ、ドメイン名はIPアドレスというルールを持った情報ではないため、
これだけでは場所を特定することができません。
そのため、ドメイン名にはIPアドレスが対応付けられています。

![image](./0025_image/01.png)

クライアントがそのドメインに接続するためには「ドメイン名をIPアドレスに変換(解決)する」という仕組みが必要です。
これをするのが「**DNS(**Domain Name System)**」です。
PCにはIPアドレスやサブネットマスク、デフォルトゲートウェイに加えて「**ネームサーバー**」をIPで指定するのが一般的です。
DHCPを使っている場合はネームサーバーも同時に学習することが多いです。
このネームサーバーがDNSを使った名前解決に利用されます。
ネームサーバーは名前解決をするためのサーバー機能で、
クライアントとなるホストはサーバーに対して「このドメインのIPアドレスを教えてください」と要求することで、
宛先にIPアドレスでアクセスすることができます。

つまり「www.yahoo.co.jp」に繋ごうと思えば、
ネームサーバーに対して「www.yahoo.co.jpのIPアドレスを教えてください」とリクエストをして、
サーバーが「IP:XXX.XXX.XXX.XXXですよ」として応答してきたアドレスにアクセスします。

![image](./0025_image/01.png)

ドメイン名だけでは宛先が分からないため、名前解決をするネームサーバーがホストに登録されていなければ、
宛先を指定するにはIPアドレスを指定するしかなくなります。
ブラウザだけでなく多くのアプリケーションはドメイン名を宛先として使いますので、
ネームサーバー及びDNSは現在のネットワークでは必須となります。

なお、実際の名前解決はもっと複雑な仕組みとなっています。
一つのネームサーバーが世界中の全てのドメインを覚えることはできないため、
複数のネームサーバーが連携する仕組みが裏側にあるからです。
詳細な仕組みについてはDNSの解説ページにて扱います。


## NTP

ホスト上では様々なアプリケーションが起動しています。
それらのアプリケーションはユーザーに時間を伝えるだけでなく、他のホストと連携をするために「時間が重要となる」ことが多いです。

PCやスマホにはマザーボードと呼ばれる基盤があり、その基板上には「**リアルタイムクロック**」と呼ばれる機能がそなわっています。
これはホストがハードウェア的にもつ時計であり、OSはその時計を参照して現在の時刻を保持します。
アプリケーションは特別なものでなければ、OSの時間をそのまま利用します。
このリアルタイムクロックは豆電池や充電池につながっているため、電源オフ時にも動作しています。
ただ、私達が使う普通の時計がそうであるように、リアルタイムクロックにも「時間がずれる」という問題があります。

人間がホストの時間を正しい時間に設定しなおすことで調整することも可能ですが、
ホストがネットワークに接続しているのであれば時間を管理するサーバーに時刻をあわせることで正しい時間を設定することもできます。
これはちょうど電波時計が電波を受けて時間を合わせるのに似ています。

「**NTP(Network Time Protocol)**」はクライアントであるホストがサーバー(NTPサーバー)に時間を合わせるためのプロトコルです。
NTPサーバーは階層構造になっていて、サーバーBはサーバーAを参照、
サーバーCはサーバーBを参照というようにサーバーとしてもクライアントとしても動作するホストが多く存在します。
全てのサーバーが間接的に参照する階層の頂点となるホストは「原子時計」と呼ばれる特別なハードウェアを持っています。

![image](./0025_image/01.png)

原子時計を持つホストは一般の組織は持っていないため、外部の信頼できる機関のNTPサーバーを社内のNTPサーバーが参照し、
その社内のNTPサーバーを社内のホストが参照するというかたちを取ります。
日本だと政府機関であるNICTのNTPサーバーなどが有名です。

NTPクライアントがどのようにNTPサーバーに時間を合わせるかについてはNTPの解説ページで扱います。
ただ、あまりにサーバーとクライアントの時間がずれていると、クライアントが時間を合わせられないことがあるというのは覚えておくべきです。
CiscoのルーターやスイッチはNTPクライアントにもなれますし、機種によってはNTPサーバーになることもできます。


## ICMP

ネットワークでの疎通性の確認に使うPingは「**ICMP(Internet Control Message Protocol)**」というプロトコルを利用しています。
このプロトコルはPingだけでなく、IPレベルでのホスト間の通知全般に使われています。

ICMPのヘッダにはタイプと呼ばれるフィールドがあり、そのタイプの値により使い方が変わります。
最も有名なものがpingにも利用される「**ICMP Echo Request**」と「**ICMP Echo Reply**」です。
Pingの送信元ホストは宛先ホストに対して「ICMP Echo Request」を送ります。
これを受け取った宛先ホストは送信元に対して「ICMP Echo Reply」を返す必要があるとプロトコルとして決まっていますので、送り返します。

送信元ホストは宛先から応答がなければ、宛先まで届いていないか、宛先からこちらのホストまで届いていないと判断します。
ただ、宛先ホストがセキュリティ的な理由でICMPに対して応答をしないように設定されている場合もありますので、
pingの応答がないから必ずIPレベルでの到達性がないとは言い切れません。
