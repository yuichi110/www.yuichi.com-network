# TCP/IP再入門

ネットワークの一番重要な知識はL2とL3の世界で、
どのようにパケット(フレーム)を転送するかという話です。
第二章から第五章まででそれらの話はおおかた終わったため、
本章ではもういちどTCP/IPの基礎に戻って通信の詳細を見つめてみたいと思います。
また、DHCPといったL2転送やL3転送には関わらないものの、
TCP/IPに関わる重要な機能の設定もプロトコルの解説に並行して取扱います。

はっきり言うとTCP/IPの仕組みは概要のみ理解していれば、
ネットワークエンジニアの日常の業務でそれほど困りません。
機器の設定をするだけであれば、VLANがどう実現されているかを知らなくてもVLANは使えますし、
特別な設定をしなくてもARPは勝手に動きます。
ただ、ネットワークの動きをきちんと理解するためには「L2転送」と「L3転送」に加えて「TCP/IP全般の知識」が必要になります。
例えば第二章で取り上げた「ARPのリクエストとリプライ」の仕組みを知らないと、
どのようにしてレイヤ2転送ができる環境が整えられているか分からないはずです。
ネットワークエンジニアの仕事は転送の仕組みを知ってネットワークを設計/運用するだけでなく、
それを支える多くのプロトコル群を理解し、
必要に応じて機器に特別な設定を加えたり障害時の調査をすることも必要とされます。

また、多くのネットワーク上のセキュリティ製品はネットワーク上のプロトコルの動きを見張っています。
セキュリティを専門とするのであれば、TCP/IPの知識は深く身につけると仕事がしやすいかもしれません。

セキュリティを専門としていなくても、仕事をしていると意外と「TCP/IPの仕組み」を前提とした議論が発生したり、
お客さんに説明をする機会を求められたりするものです。
責任を持ってネットワークエンジニアとしての仕事をこなすためにも、きちんとTCP/IPの概要を知っておいてください。
なんとなく機器に設定をしたり運用をするエンジニアと、
TCP/IPの詳細や機器の仕組みを知った上で設定や運用をするエンジニアは質が違います。
後者のほうが正しいネットワークの設計をしますし、障害時の対応速度が早いです。

# パケットのキャプチャと確認

本章ではTCP/IPの各レイヤーごとの役割に加えて、L3フレームやL3パケットの構造を取り扱います。
それらを仕様書を参照して説明してもいいのですが、せっかくですので主要なものは実際に流れている通信をキャプチャ(取得して保存)して確認したいと思います。

通信のキャプチャをする手法はいくつかありますが、
おおまかに「通信しあっているホスト(PCやサーバー)」自体で取得するか、ホスト間の通信が通過するネットワーク機器でキャプチャするかのいずれかです。
前者はホスト上でキャプチャツール(WiresharkやTCPDump)を使うのが主流で、
後者は「SPAN」や「ミラーリング」と呼ばれる仕組みを使ってトラフィックをコピーしてキャプチャ用のマシン(WiresharkやTCPDumpを利用)がつながれた別のポートに流します。
VIRLを使う場合はシミュレーターの機能を使ってキャプチャができるので簡単です。
この手法は本書の補足に記載しています。

<<図>>

このようにしてキャプチャしたパケットはキャプチャソフトがファイルとして保存します。
それを「ネットワーク・アナライザ」と呼ばれるソフトウェアを使うことで、いつにどのようなパケットが流れているか確認できます。
このアナライザ機能もワイヤーシャークやTCPDumpが提供しており、「パケットを表示しながらキャプチャする」ということもできます。

<<図>>

パケットのキャプチャは障害発生時にどこでパケットが落ちているか調査するために使ったり、
通信プロトコルをリバースエンジニアリング(機器の挙動から実装を推測)する際によく利用されます。
例えば「ここまで届いているけど、ここで通信が落ちている」とわかると、通信経路上で問題を起こしている機器を特定できます。
他には「プロトコルAがうまく動きません」という場合に機器間のやりとりを調べることで、
「この機器が標準に準拠しない動きをしている」と特定することができる場合があります。
これらの調査はカウンタの増減のチェックや、機器が持つデバッグ機能といった簡易的な手法と組み合わせて利用することが一般的です。

PC2(config)#enable password cisco
PC2(config)#line vty 0 4
PC2(config-line)#password cisco
PC2(config-line)#login
PC2(config-line)#transport input all

# プロトコル・スタックの復習

ネットワークに求められる機能は通信の種類によって変わります。
たとえばファイル転送であれば、そのファイルが壊れていたらどうしようもないため信頼性が求められます。
ただ、リアルタイムに行われるビデオ会議などでは遅延(タイムラグ)の少なさが求められます。
1つの「ネットワークのプロトコル」という形で壮大な仕組みを作ってしまうと、
プロトコルとして上記のような様々な要件を満たすことが難しくなりますし、
それを機器で実装することが難しくなります。

TCP/IPはネットワークの機能に階層(レイヤー)をもうけて、
そのレイヤーごとでパーツを組み合わせることで必要とされるネットワークを提供します。
たとえば「物理的なケーブル(光、銅線)と無線(wifi)」の種類をL1とL2で多様性を持たせることができます。
L4でTCPを使えば通信に信頼性を持たせることができますし、UDPを利用すれば遅延を抑えることができます。

<<図>>

本章では下のレイヤーから上のレイヤーに上がっていくという形でTCP/IPの仕組みを扱います。
なお、私の個人的な意見となりますが、L2とL3転送の仕組みを知らずにTCP/IPを詳細に学ぶことは、
木を見て森を見ないようなものだと考えています。
フレームやパケットの詳細なフォーマットは調べればすぐに分かるため暗記する必要はありません。
それよりも構築や検証経験を多く積むことで大局観を掴むことを優先したほうがいいかもしれません。

# ネットワークインターフェース層

TCP/IPにおいてはケーブルの種類といった物理的なネットワークの媒体と、
そのうえで動くリンクのプロトコル(例えばMACアドレスを使う第二章で学んだイーサネットなど)は密接に結びついており、
レイヤーとしては分けられていません。
ツイストペアケーブルを使えばMACアドレスを使うイーサネットプロトコルを利用するといった具合です。
TCP/IPでは両者をまとめて「ネットワークアクセス」と呼びますが、TCP/IPのベースとなったOSIモデルで物理をL1、
リンクをL2と呼んでいたため、その呼び方が一般化しています。

L1の詳細な仕組みは別の専門分野(電気電子工学、光学など)となるため、
ネットワークエンジニアはそれほど熟知する必要はありません。
例えば無線LANの電波がどのようにデータを波に変換しているかということは、それを専門にするエンジニア以外は詳細を知りません。
ただ、適切なネットワークインフラを構築/保守するためにも、
主要なL1/L2の種類については「どのような特性があるのか」「どのような仕組みで動いているのか」を理解する必要があります。

## イーサネット

ネットワークエンジニアが最も多く触れるのはL2プロトコルは「イーサーネット」と呼ばれるもので、
家庭用のPCやルーターを接続するツイストペアケーブル(いわゆるLANケーブル)で使われています。
このイーサネットはツイストペアケーブル以外でも様々な種類のケーブルで利用されており、
例えば光ファイバを使ったり、Twinaxと呼ばれる10Gの帯域を持つ銅線ケーブルでも利用されています。
昔はイーサネット以外の様々なプロトコルが利用されていましたが、
近年はイーサネットがほぼ業界標準となっています。
そのため、より広い帯域を使うために新しい通信媒体が開発されても、
そのうえで動くプロトコルにはイーサネットが使われることが多いです。

以下にL1とL2の関係を図にまとめます。

<<図>>

同じイーサネットというプロトコルを使っているため、
スイッチに1GのLANケーブルと10GのTwinaxがささっている場合であっても、
スイッチを経由して両者の先にいる機器同士が直接通信することができます。

イーサネットのデータはフレームと呼ばれており、以下のような構造となっています。

<<図>>

VLANタグを使わない場合は構造が単純で送信先と送信元MACアドレスと、
上位のプロトコル(インターネット層)を示すタイプフィールドがあります。
その後ろに通信データがあり、最後にFCSと呼ばれるデータ誤りを検知するための値が書き込まれています。
第二章で説明したようにスイッチはこれらのMACアドレスを使ってフレームをL2転送したり、MAC学習したりするのでした。
そしてFCSを使ってフレームが壊れているか否かを判定し、
壊れていればフレームを破棄します(高速な転送を優先して破棄しない「カットスルー」と呼ばれる転送方式のスイッチもあります)。

フレームを受け取ったPCやルータなどの機器は、その宛先MACが自分のMACアドレスであるかを確認します。
それが自分のMACアドレスでなければ無視し、もしそうであればタイプフィールドを確認し、
上位のプロトコル(IPなど)に応じた処理を実現します。
少し複雑なのがSVIを持つL3スイッチで、受け取ったフレームの宛先MACアドレスが自分自身のSVIのMACアドレスであれば、
それをSVIで上記のL3処理をし、そうでなければL2転送をするという動きをします。

VLANタグをフレームが持つ場合はもう少し構造が複雑になります。

<<図>>

宛先/送信元MACの後に4バイトのTAG(この一部がVLAN番号に使われる)が挿入されます。
VLAN番号だけでなくフレームの優先度を示す情報などが書き込まれます。
同一ネットワーク内で輻輳が発生した場合は、この優先度を基準にして優先度の低いフレームを破棄したりします。

このタグで重要なのが「VLAN ID」と呼ばれる12bitのフィールドで、2の12乗パターンで「0から4095」まで表現できます。
ただ、これが全て使えるわけではなく0や4095及び1002-1005はシスコのスイッチでは特定の目的に利用されるため、
ユーザーは利用できません。

スイッチを使うのであれば、以下のような状態遷移でフレームが処理されていると認識できます。

<<図>>


## 無線LAN(wifi)

一方、wifiはイーサネットとはプロトコルが若干異なっています。
そのため、アクセスポイントなどの2つのL2プロトコルを理解できる機器が
イーサネットと802.11の変換をしてL2の世界を広げています。
ただ、類似性のない全く異なる2つのL2プロトコルを同じL2ネットワークに組み込むことはできないため、
そのような場合はルーターなどでネットワークを区切ります。

それでは実際にL2イーサネットのデータである「フレーム」を確認してみます。
まずVLANなしのフレームです。

<<図>>

L2フレーム

## PPP (PPPoE)


他のレイヤ(L3以上)に比べると

L1とL2は密接に関係している
企画をあわせる

光 <-> Copper
Copper の規格



## L3 Packet

TCP/IPにおいてネットワークインターフェース層の上にあるのがインターネット層です。
OSI参照モデルのレイヤーの位置より「L3」と呼ばれており、「IP」がその中心的なプロトコルです。

MACアドレスが同じネットワーク内のデータ転送(L2転送)で使われていたように、
IPが持つIPアドレスは異なるネットワーク間のデータ転送(L3転送)で利用されます。
つまりIPアドレスは送信元ホストから宛先ホストにデータを届けるために利用されるということです。
ネットワークにおいてIPは中心的にな役割を果たしています。

イーサネットに比べると、IPのヘッダの構造は複雑です。

<<図>>

一番重要なのは宛先/送信元IPです。
サブネットの情報は含まれていないため、パケットを見るだけではネットワークアドレスとホストアドレスの境界は分かりません。
サブネットはルーティングをするルーター(L3スイッチ含む)や、デフォルトゲートウェイを使うPCが保持しています。

他にはパケットがフラグメント化されたかを示すフラグメント関係のフィールドや、
ネットワークをいくつホップしたかを示す「Time To Live」や、
上記のL4プロトコル(TCPやUDPなど)を示す「Protocol」や、
IPパケットの大きさを示す「Total length」などが重要です。
また「Type of service」はネットワークを跨ぐ通信でパケットの優先度を示すために利用されます。

ルーターがパケットを処理する流れの状態遷移を以下に記載します。

<<図>>

上記にもあるようにTTLはホップ数の管理に用いられており、
ホップするごとに数を1つずつ減らして0になればパケットが破棄されて破棄通知のICMP(後述)を返します。
今までパケットのL3通信経路を確認するためにトレースルート(traceroute)コマンドを使ってきましたが、
これはこのTTLを利用しています。

<<図>>

なお、トレースルートでの通信経路の特定を外部の第三者にされたくない場合はICMPを返さないようにするか、
途中の通信機器でそれをフィルタするようにします。
組織内での通信経路特定は障害時の対応などに役立つため、
機能をオフにするよりは外部にICMPを漏らさないようにする設定がよいかもしれません。

他にはIPパケットはフラグメントと呼ばれる「データの分割」もされることがあります。
これは後ほどMTUのお話をしますのでそのときに扱います。



# L2/L3 主要プロトコルの動き

## Spanning Tree

## ARP

パケットの宛先IPが同じネットワーク内の機器であれば、そのIPを持つ機器に対してデータを転送します。
宛先IPが同一ネットワークでない場合はルーティング処理が必要ですので、
デフォルトゲートウェイに登録されているIPを持つ機器か、
ルーティングテーブルでそのネットワークアドレスに対してネクストホップとして指定されているIPを持つ機器に転送を行います。
宛先IPが同一ネットワークでないにも関わらず、デフォルトゲートウェイもルーティングテーブルのエントリもない場合はパケットは破棄されます。

つまり同一ネットワーク内でイーサネットフレームを使ったL2転送が発生する状況では、
宛先機器のIPアドレスは特定できているわけです。

既にお話したようにイーサネットのL2転送ではIPアドレスではなく、MACアドレスを使って転送します。
宛先機器のIPアドレスは既に特定できていますので、そのIPアドレスを持つ機器のMACアドレスを得られればL2転送できます。
ARPを使うことで「IPアドレスXを持つ機器のMACアドレスYを得る」ことができます。

<<図>>

実際にパケットキャプチャをすることでARPの動きを確認してみます。


## DHCP

今までPCとして利用してきたルーターでは、通信をさせるために以下の3つの設定をしていました。

* IPアドレス
* サブネットマスク
* デフォルトゲートウェイ

IPアドレスを持っていないと通信できませんし、
サブネットマスクが定義されていないと同じネットワークか否かが判断できません(L2転送すればいいのかL3転送すればいいのか分かりません)。
そしてデフォルトゲートウェイが設定されていないと、他のネットワークに通信するために誰にパケットをL3転送してもらえばいいか分かりません。

これらの設定を物理的に移動するごとに手動で設定するのは面倒です。
会社に着いたらノートPCのネットワーク設定を会社のネットワーク用にして、
家に着いたら家用の設定に切り替えるといったことはしたくありません。
さらにホテルや公共スペースの無線LANであれば、どのIPを設定すればいいかといったことは誰も教えてくれません。

ルーターなどのネットワーク機器は他の機器に利用されるため、IPアドレスは簡単には変更できません。
例えば無断でアドレスを変えればデフォルトゲートウェイに到達できなくなったなどとして怒られてしまいます。
ただ、ルーターなどのネットワーク機器と違って、
ノートPCやスマホといったユーザーの機器は通信さえできれば問題ないのではないでしょうか。
ホテルのネットワークが10.0.0.0/8だろうと、172.16.0.0/24だろうとインターネットにさえ繋がれば私は気になりません。

DHCPはインターフェースにIPアドレスなどを自動的に設定するための仕組みです。
DHCPを使うことで手動でネットワークの設定をしなくても、
ネットワークに接続した際に「ネットワークの設定を教えてください」と問い合わせて、
その問い合わせを聞いた「DHCPサーバー」が「これを設定してください」と問い合わせをした機器に応答します。
それを取得した機器はその情報を使ってネットワークに参加します。

<<図>>

この流れをパケットキャプチャを使って詳細に確認してみます。

169.254

## ICMP

ICMPはTCP/IPのIP層を陰ながら支えるプロトコルです。
例えばパケットの到達製を調べるために使ってきたpingも、ICMPを使って実現されています。
ここではICMPの主要な役割や、そのフォーマットについて確認したあとで、pingを使いこなす方法についてお話します。


## DNS

DNSは「ドメイン名」から「IPアドレス」を解決するための仕組みです。
L2やL3レベルでは必ずしも必要なプロトコルではありませんが、現実世界のネットワークでは必須のものです。


## NTP
## OSPF


# UDP と TCPとポート番号

インターネット層の上に位置するトランスポート層にはTCPとUDPがあります。
リンク層(イーサネット)及びインターネット層(IP)と、このトランスポート層の役割には決定的な違いがあります。
前者はデータをエンドホストの間でスイッチやルーターを介して届けあうために利用されるのに対し、
後者は中継機器では使われずにエンドホストでのみ利用されます(一部例外はあります)。

ブラウザで大きなファイルをダウンロードをする際に1つのパケットやフレームにそれを全部収めることはできません。
そのため、データを送る側はデータを小さく分割して順番にパケットとして送信し、
受信する側は分けられたデータをパケットとして受け取って順に結合していきます。
この結合処理をする際にデータが欠けていたり、間違った順序で結合してしまうと、元のファイルを受信側で復元することができません。

IPパケットは「データを確実に届けること」や「正しい順序で届けること」を保証していません。
そこでネットワークを使いたいアプリケーション層(ブラウザ)とデータを送るインターネット層(IP)の間に、
「通信を保証」するトランスポート層のTCPを挟むことでデータを「確実(欠けることなく)」に「正しい順序」でやりとりすることができるようになります。
詳細な仕組み後で扱いますが、パケットが欠ければそれを再送し、順序が乱れればそれを直します。
これがTCPの役割です。
他には複数の通信(ブラウザで複数のファイルをダウンロードしつつ、メールを取得)を同時に行ったり、
サーバーで複数のサービスを同時する際にそれらを区別するための目印をつける役割も持っています。

<<図>>

ただ、この通信の信頼性を保証するのは必ずしもTCPではなく、アプリケーション自体でやりくりするという方法も考えられます。
例えばデータを転送するアプリケーションが分割されたデータごとにヘッダを与えて自分自身で再送や並び替えをすることもできます。
TCPはアプリケーションの開発者にこのような面倒な作業をさせずにすむように存在していますが、
アプリケーション開発者が自分自身で全てをコントロールしたい場合もあります。
このような場合はTCPではなくUDPを利用します。
UDPは同時に実行される通信の種類を区別する(例えばUDPのビデオ会議映像を眺めつつ、別のUDPを使ったIP電話をかける)という役割はありますが、
TCPのような欠けたデータを再送したり、パケットを並べ替えたりといった仕組みを提供しません。
一方、再送などが発生しないのでエンドホスト間のやりとりがTCPより少なく済むため、「データの往復にかかる時間が圧倒的に短い」
「データ量が少ない」といった特徴があります。

<<TCPとUDPの比較表>>

世の中の多くのエンドホスト間のやりとりはデータ量を削ったり、通信時間を短くするよりも信頼性を求めます。
そのため、多くのアプリケーションはUDPではなくTCPを利用しています。

## UDP

TCPは複雑なので、先にUDPを扱います。
信頼性を得るための仕組み以外は、TCPとUDPに大差はありません。

UDPセグメントのフォーマットは以下のようになっています。

<<図>>



## TCP

# アプリケーション

ロードバランサ
DNSラウンドロビン

# ネットワークの性能

MTU
 - カプセル化
 - 大きい方が効率が高い

## 機器の処理能力
 - インターフェース(リンクレベル)
 - 中身の能力

みなさんが自宅のPCやルーターを買う際に、
それらのポート(NIC)が1Gbpsであるか100Mbpsであるかといったことを気にされたことがあるはずです。
これらの速度は「通信速度」や、より専門的には「帯域」などと呼ばれいます。
これをもう少し細かく説明してみましょう。

まず1Gbpsや100Mbpsの「bps」は「bit per second」の略で、
日本語にすると「1秒間のbit」という意味になります。
つまり1Gbpsは「1秒間に1Gbit(1,000,000,000bit)」のデータを送受信できるということです。

先にお話したようにデータはフレームという形で機器間でやりとりされています。
仮にMTUが1500バイトとして設定されていて、通信に使う全てのフレームが1500バイトだとします。
1,500バイトは12,000ビットです。
1Gbpsでは「1,000,000,000 ÷ 12,000」で約83,333フレームが1秒間に送受信されるということです。
MTUが9000バイトだとすると、同様の計算で約13,889フレームが1秒間に送受信されます。

NICのインターフェースが1Gbpsを使えるということは、理屈的には上記の性能が達成できるということです。
ただ、家庭用の機器や安い業務用の機器ですと規格としては1Gbpsを備えていても、
実際にはその性能を出せないことが多々あります。
そういった場合はフレームがドロップされてしまいます。

業務用の機器であっても10Gインターフェースから2Gbpsのレートで届けられたフレームが、
1Gbpsのインターフェースの先にいる機器にスイッチング(ルーティング)される場合は機器の内部でドロップが発生します。
ただ、一般的にエンド間のTCPのやりとりで通信速度が制限されるため、
このように露骨にドロップが発生することは多くありません。

RTT
 - ホップ数
 - 機器のASICデザイン

帯域幅

通信の「速さ」と「帯域」

信頼性

アプリケーションレベルでのRTT




# トラフィックジェネレーター

# コラム

TCP/IP以外のネットワーク
 - 歴史的なもの: ARPA NET, token ring, apple talk
 - Storage Area Network
