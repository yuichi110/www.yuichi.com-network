

## 自宅のインターネット回線の裏側


多くのかたがNTTやサービスプロバイダー(OCNやSo-netなど)とインターネット接続の契約を結んだ経験があると思いますが、
これは自宅のPCをインターネットに繋げるために行っています。
繋ぎかたには様々な方法がありますが、日本で最も主流なのは「NTTの回線を使ってサービスプロバイダーに接続する」という形式です。

ご存知のようにNTTは固定電話のための回線を提供することを主なビジネスとしていました(今は違います)。
電力会社が電信柱を経由して家庭に電力を供給するのと同じように、NTTも電信柱を使って家庭に電話回線を提供していました。
現在は多くのエリアで電話回線から光ファイバーに置き換えられていますが、このNTTが持つ物理的な回線を使って、
家とサービスプロバイダーを接続しています。

家にあるPCはこのサービスプロバイダーのネットワークに接続されます。
そしてインターネットを経由して、サービスプロバイダーのネットワークからYahooやGoogleのネットワークにあるサーバーに接続するのです。

![image](./0005_image/01.png)

## スマホのインターネット回線の裏側

スマホがインターネットを使えるのもこれと似た仕組みで、NTTの光ファイバの代わりに無線でDocomoなどに接続し、
Docomoを経由してインターネットに出ていきます。
この仕組を以下の図にまとめます。

![image](./0005_image/01.png)

このようにして、自分の家のPCや外出時のスマホがインターネットに接続されると、
同じくインターネットに接続されているYahooやGoogle及びその他のウェブサイトと繋がることができるようになります。

ただ、ネットワークで相手(この場合はサーバー)に繋がるには、相手がどこにいるかを指定する必要があります。
これはネットワーク上の住所であるIPアドレスという仕組みを使います。
本書籍を手にとるようなかたであれば、「192.168.0.1」や「10.0.0.1」などというアドレスを見たことがあるのではないでしょうか。
各ドットの区切り(オクテットと呼ばれる)は0から255までありますので、
IPアドレスの組み合わせは「256 x 256 x 256 x 256」個の合計「42億9496万7296」個となります。
(厳密にはこれは正確な表現ではないので、後ほど詳細を扱います。)

インターネットに接続されているネットワークはそれぞれIPアドレスのレンジを持っています。
たとえばYahooのネットワークは「1.0.0.0」から「1.255.255.255」までを持っているとしましょう。
Googleは「2.0.0.0」から「2.255.255.255」であり、サービスプロバイダーは「3.0.0.0」から「3.255.255.255」です。

サービスプロバイダーの中にある自分のPCは、当然ながら「3.0.0.0」から「3.255.255.255」の間のどれか一つのアドレスを持ちます。
今回は「3.0.0.100」としましょう。
それがYahooのサーバー(1.0.0.100とします)と通信しようと思うと、
郵便配達と同じような仕組みで、まずは「1.0.0.0」というYahooのネットワーク自体に通信データ(パケット)を届けようとします。
そしてインターネットを経由してYahooのネットワークにパケットが届いたら、
Yahooのネットワークの中でそれを1.0.0.100のアドレスを持つサーバーに届けます。
これはちょうど、大阪(サービスプロバイダー)の家から東京(Yahoo)の家に荷物を届ける際に、
「まずは東京(Yahoo)の集荷所に荷物が配送され、東京の中で新宿区のXXさんの家に届ける」というような流れに似ています。
Yahooのサーバーから自宅のPC(サービスプロバイダーのネットワーク内)に返信データを届けるときも、
これと同じ仕組みとなります。
なお、パケットの中身の詳細は後ほど扱いますが送信先のアドレスと送信元のアドレス(返信が必要なため)と、
相手に届けるデータ(データグラムと呼ばれる)を持っています。



# L2/3の冗長化技術

企業のネットワークが停止するということは仕事に大きな支障が発生します。
パッと思いつくのはインターネットに繋がらなかったら不便ということかもしれませんが、
現在の多くの企業は社内システムをIT化していますので、
たとえば店舗などでは商品発注や在庫管理などができなくなってしまいます。

今までお話してきた第二章から第四章までの構成は、機器の故障を一切考慮していません。
試しに機器を「reload」コマンドで再起動してみると、再起動している間の通信は全く通らなくなります。
家のPCや家電が壊れるように、企業が使っているネットワーク機器も壊れますので、
「1つの機器が壊れたら社内ネットワークが使えなくなります」という構成は許容されません。

この一箇所壊れたら使えなくなる箇所は「SPOF(Single Point Of Failure)」と呼ばれており、
ネットワークの冗長化技術を使うことでSPOFの数を可能な限り減らすことが必要です。
本章ではこの冗長化技術をリンクレベル、L2レベル、L3レベルで順に扱います。

なお、全てを冗長化する必要がないことは認識する必要があります。
例えばノートPCのネットワークのポートは1つしかないため、そこを冗長化することはしません。
今だったら無線Lanがあるので、それで冗長化になっているかもしれませんが。
また、信頼性がさほど必要のない検証環境では、とにかく安く抑えるためにスイッチなどのインフラを冗長化をしないという場合もあります。
商用環境ではないので落ちたところで不便以上の大きな影響はないため、壊れたらベンダーの保守契約で翌日交換などすれば問題なしという姿勢です。
コストと信頼性の優劣は資金や環境によって異なりますので、適切な冗長化レベルを選択する必要があります。

## リンクの冗長化

Wifiを使うノートPCやタブレットといったユーザー機器を除けば、ネットワーク上の機器と機器は基本的にケーブルで接続されています。
みなさんの自宅にあるようなLANケーブルも一般的ですし、
10Gやそれ以上のスピードが求められる環境では専用の銅線ケーブル(Copper)や光ケーブル(Fiber)を使う場合もあります。
これらのケーブルやケーブルを挿すポートは確率こそ高くないものの壊れることがあります。
(私の体感的には中長距離を接続する光ケーブル用の光信号をやりとりする着脱式のSFPと呼ばれるモジュールが壊れる確率が若干高いです。)

2つの機器が1本のケーブルで接続している際に、それが壊れると当然ながら2台が切り離されてしまいます。
この問題を予防するために、複数のケーブルを論理的に一本に束ねる技術があり、
それが「LAG(Link agligation)」や「Port Channel」「Ether Channel」と呼ばれるものです。
使う機材によって呼び方が変わりますが、一般的にはサーバーではLAG、ネットワーク機器ではチャネルと呼ばれることが多いようです。
本書ではチャネルで統一します。
チャネルに参加するポートのことをメンバーポートと呼びます。

<<図>>

実はたんに複数本のリンクでスイッチ同士を接続するだけでも後述するスパニングツリーで冗長化が実現されるのですが、
チャネルを使うと複数本のリンクを一本の論理的なリンクにするためスイッチ間の帯域が広がります。
そのため、スイッチ間のリンクではチャネルが多用されますし、サーバーへの接続にもチャネルが利用されます。

チャネルを使うべきに考慮すべきことは接続する両方の機器の設定をそろえることです。
例えば接続するスイッチの片側だけチャネルの設定をして、もう片側はなにもしないということはありません。
両方のスイッチで統一されたチャネルの設定が必要です。
他には利用するプロトコルも考慮する必要があります。
一般的にはチャネル用のプロトコルを何も使わない「スタティック」と呼ばれる設定にするか、
接続しているリンクが間違っていないか、相手が生きているかを確かめる「LACP」と呼ばれるプロトコルを使う設定にするかのどちらかです。

以下の構成で実際にチャネルの設定をします。

<<図>>

チャネルの設定をする際は、念のためにインターフェースをダウンさせてください。
先にお伝えしたように両方のスイッチが同じ設定を持つことが望ましいため、
片側ずつ順に設定をいれるとチャネルの設定がされている側とされていない側が存在する状況に一時的になります。
両者のチャネルの設定が終わった段階でリンクをアップさせれば問題ありません。

```
L2SW3(config)#int range g0/0-3, g1/0
L2SW3(config-if-range)#shut
```

チャネルの設定をするには、チャネルのメンバーポートの設定を全て統一したうえで、
「channel-group <チャネル番号> mode <チャネルモード>」コマンドを発行します。
一般的にはメンバーポートに余計なコマンドが入っていたら全てnoコマンドで消して初期化してしまい、
そのうえで上記のchannel-groupコマンドを発行します。

今回のスイッチはインターフェースに何も設定されていないので、
そのままrangeを使って複数インターフェースを指定して、channel-groupコマンドを発行します。
g0/1とg0/2をチャネル番号1とし、スタティック設定(mode on)にします。
g0/3とg1/0をチャネル番号2とし、これをLACPの設定(mode active)にします。

```
L2SW3(config)#int range g0/1-2            
L2SW3(config-if-range)#channel-group 1 mode on
Creating a port-channel interface Port-channel 1

LACPの設定
L2SW3(config)#int range g0/3,g1/0
L2SW3(config-if-range)#channel-group 2 mode active
Creating a port-channel interface Port-channel 2
```

上記のメッセージにもあるように、新しく「Port-Channel1 (Po1)」と「Port-Channel2 (Po2)」が作成されました。

```
L2SW3#show int status

Port      Name               Status       Vlan       Duplex  Speed Type
Gi0/0                        disabled     1            auto   auto RJ45
Gi0/1                        disabled     1            auto   auto RJ45
Gi0/2                        disabled     1            auto   auto RJ45
Gi0/3                        disabled     1            auto   auto RJ45
Gi1/0                        disabled     1            auto   auto RJ45
Po1                          notconnect   unassigned   auto   auto
Po2                          notconnect   unassigned   auto   auto
```

どのチャネルにどの物理インターフェースが割り当てられているかは「show etherchannel summary」コマンドで確認できます。
割当に加えて、チャネル自体の状態(アップしているかダウンしているか)やプロトコル、メンバーごとの状態も把握できます。

```
L2SW3#show etherchannel summary
Flags:  D - down        P - bundled in port-channel
        I - stand-alone s - suspended
        H - Hot-standby (LACP only)
        R - Layer3      S - Layer2
        U - in use      N - not in use, no aggregation
        f - failed to allocate aggregator

        M - not in use, minimum links not met
        m - not in use, port not aggregated due to minimum links not met
        u - unsuitable for bundling
        w - waiting to be aggregated
        d - default port

        A - formed by Auto LAG


Number of channel-groups in use: 2
Number of aggregators:           2

Group  Port-channel  Protocol    Ports
------+-------------+-----------+-----------------------------------------------
1      Po1(SD)          -        Gi0/1(D)    Gi0/2(D)    
2      Po2(SD)         LACP      Gi0/3(D)    Gi1/0(D)    
```




L2SW3#show etherchannel summary
Flags:  D - down        P - bundled in port-channel
        I - stand-alone s - suspended
        H - Hot-standby (LACP only)
        R - Layer3      S - Layer2
        U - in use      N - not in use, no aggregation
        f - failed to allocate aggregator

        M - not in use, minimum links not met
        m - not in use, port not aggregated due to minimum links not met
        u - unsuitable for bundling
        w - waiting to be aggregated
        d - default port

        A - formed by Auto LAG


Number of channel-groups in use: 2
Number of aggregators:           2

Group  Port-channel  Protocol    Ports
------+-------------+-----------+-----------------------------------------------
1      Po1(SU)          -        Gi0/1(P)    Gi0/2(P)    
2      Po2(SU)         LACP      Gi0/3(P)    Gi1/0(P)    

マッピングの確認


L2SW3#show mac address-table
          Mac Address Table
-------------------------------------------

Vlan    Mac Address       Type        Ports
----    -----------       --------    -----
   1    0000.0000.0101    DYNAMIC     Po1
   1    0000.0000.0102    DYNAMIC     Po2
   1    fa16.3e28.b93e    DYNAMIC     Po1
   1    fa16.3e38.e7b9    DYNAMIC     Po2
   1    fa16.3e8c.f77e    DYNAMIC     Po2
   1    fa16.3e98.78ea    DYNAMIC     Po1


ロードバランスの話が必要。
ハッシュアルゴリズムの計算

## Spanning Tree

チャネルを使うことで機器間のリンクを冗長化することはできました。
ただ、ケーブルやポートが壊れることがあるのと同じように、スイッチ自体が壊れたり停止(再起動)すべき状況になったりする場合もあります。
そのような状況はチャネルでは救えないため、L2の機器同士の接続も冗長化する必要があります。
これを実現する手法な様々ですが、最も一般的なものが「STP(Spanning Tree Protocol)」を使って、接続を冗長化するというものです。

詳細なSTPの仕組みは後ほど説明しますが、以下の2つの構成(VLAN1しかないとします)を見比べるだけでも、
機器自体を冗長化する必要性が分かるのではないでしょうか。

<<図>>

今まで用いてきた構成ですと

ただ、第二章で学んだスイッチの動きを思い出して下さい。
スイッチがブロードキャストフレーム(ARPなど)や、MAC学習していないユニキャストフレームを受け取った場合は、
それを同一のVLANのポート(今回は図の全て)に全てフラッディングするという動きをするのでした。
上記のように接続されている状況でフラッドされるフレームが発生すると、
例えば以下のようにARPパケットがフラッディング(1入力N出力)を繰り返して、
フレーム数を増やしながらぐるぐるとループし続けてしまいます。
こうなってしまいますと、そのフレームがネットワークのトラフィックを埋め尽くして、ネットワーク障害が発生します。

<<図>>

スパニングツリープロトコルは「冗長化をしつつ、L2ループを防ぐ」ための技術です。
より具体的にいうと、図左のような冗長性を持った接続であっても右側のようなL2の通信経路を作り、
障害が起きると新しい通信経路に切り替えることで通信を継続させます。
ループが発生できないL2ネットワークの形は「木構造」です。
スパニング「ツリー」という名前からも分かるように、このプロトコルは複数のスイッチ同士でお互いに会話をして、
木構造のL2ネットワークを構築します。

どのように情報をやりとりしているか説明をするまえに、実際に障害時にどのように経路が切り替わるのか説明しましょう。
例えばスイッチ自体に障害が発生した場合は以下の図のように障害に対処します。

<<図>>

木構造の頂点(ルート)のスイッチが故障により停止したため、頂点を隣にある冗長化のためのスイッチに切り替えています。
この切替はスイッチ同士の会話が絡むため数秒から数十秒ほど時間がかかりますが、
それでも4時間配送(ベンダーの保守契約)の交換作業を待ったり、人手でバックアップ機器に取り替えるより素早く障害から復旧します。

スイッチ自体に問題がなくても、リンクが切れてしまった場合も通信経路のパスを切り替えることもできます。
例えば以下のシナリオではツリーの頂点(ルート)は同じままで木構造が変化しています。

<<図>>

この木構造の構築ですが、基本的には以下のルールを覚えれば十分です。

1. ツリーの頂点(ルート)に選ばれるのは最もプライオリティが高いスイッチ
2. 頂点から末端にかけて帯域が広いリンクを優先してパスを作る
3. ルート側のポートが上流、それ以外が下流
4. ルートまでの到達するポートが複数ある場合は、到達コスト(通る経路のコストの足し算)が最も高いリンク以外はブロックする

試験対策などであればより詳細なルールを覚える必要がありますが、
一般的にL2ネットワークは「物理構成に階層を作り、複雑さを減らす」という構成をとります。
そのような状況下ではツリーの構造が明確なため、スパニングツリーのアルゴリズムの詳細を知らなくても構造が把握できます。
具体的には以下のような構成を取るのが鉄板です。

1. 上流スイッチ(コア層)と下層スイッチ(アクセス層)の2階層構造とする
2. 上流のスイッチは冗長化して互いに接続する。コア層を3台以上にすることはほぼない。
3. 上流の階層にあるプライマリとなるスイッチのプライオリティをあげる
4. プライマリのバックアップとなるスイッチを2番目のプライオリティにする
5. 下流にいるスイッチ群のプライオリティはデフォルト値(低い)のままで問題ない。
6. 下流にあるスイッチ同士はお互いに接続をしない
7. サーバーなどの重要な機器は2つのアクセス層のスイッチに接続する(脱線するためコラムで扱う)

下流にあるスイッチ同士をお互いに接続したほうが、
それに繋がるPC同士の通信が近そうな気がするかもしれません。
ただ、そのリンクはスパニングツリープロトコルでブロックされるため、どうせ使われません。
2台の上流スイッチの両方が死んだ時はもう外に通信できない状況ですので、
その状況で下流スイッチ同士の通信は考慮しなくて構いません。
サーバーなどはアクセス層のスイッチの障害にそなえるために2つのアクセス層のスイッチに接続したりしますが、

規模によってはアクセス層とコア層の2階層ではなく、
アクセス制御のための「ディストリビューション層」を間に挟む3階層にする場合があります。
ただ、機器のパフォーマンスが向上しているので2階層構成にして、
それ以上になる場合はネットワークを切る構成のほうが昨今だといいかもしれません。

長くなりましたが、上記条件を満たす以下のトポロジーを使ってスパニングツリーの設定を行い、
障害時の挙動を確認します。

<<図>>

スパニングツリーはVLANごとに設定できます。
つまり、VLANごとにツリーの構造を変えられるということです。
コアスイッチ1を全てのVLANのルートとして使ってもいいのですが、
負荷分散させる目的でVLAN1のルートをコアスイッチ1にし、VLAN2のルートをコアスイッチ2にします。
VLANごとに設定範囲が異なる可能性があるため誤差はあるでしょうが、
ツリーの形は「どちらのコアスイッチをルートにするか」で決まるため、
おおまかには2種類しか存在しません。

L2及びL3スイッチでスパニングツリープロトコルはデフォルトで有効になっています。
設定を加える前にスパニングツリーの状態を「show spanning-tree」コマンドで確認します。

```
L2CS1#show spanning-tree

VLAN0001
  Spanning tree enabled protocol ieee
  Root ID    Priority    32769
             Address     5e00.0002.0000
             Cost        4
             Port        3 (GigabitEthernet0/2)
             Hello Time   2 sec  Max Age 20 sec  Forward Delay 15 sec

  Bridge ID  Priority    32769  (priority 32768 sys-id-ext 1)
             Address     5e00.0004.0000
             Hello Time   2 sec  Max Age 20 sec  Forward Delay 15 sec
             Aging Time  300 sec

Interface           Role Sts Cost      Prio.Nbr Type
------------------- ---- --- --------- -------- --------------------------------
Gi0/1               Desg FWD 4         128.2    P2p
Gi0/2               Root FWD 4         128.3    P2p
Gi0/3               Desg FWD 4         128.4    P2p

<以下省略(VLAN2の情報が続く)>
```

このコマンドでは大まかに利用しているSTPの種類、
ルートスイッチ及び自分自身の「ルートになるためのプライオリティ値」と、
自分自身のポートの状態が分かります。

VLAN番号の後に表示されている「Spanning tree enabled protocol ieee」がSTPのプロトコルです。
Ciscoの機器ではSTP(PVSTとも呼ばれる), RSTP(Rappid STP), MSTの3つが使われており、ieeeはデフォルトのPVSTです。
RSTPはのほうが障害時の収束がSTPよりも高速であるため、特別な理由がない限りRSTPを利用して下さい。
MSTはRSTPの亜種でVLANをグループ化して設定できます。
VLAN数が多い場合は「設定をシンプル化」「スイッチ間の会話を減らす」ためにMSTを使ってください。
今回はVLANが2つしかないため、後ほどRSTPに変更をします。
あたりまえですが、同じセグメントにいる全ての機器でプロトコルは統一してください。

「Root ID」で表示されている情報がルートスイッチのもので、その下の「Bridge ID」が自分自身のものです。
全て重要な情報なのですが、最も大事なのは「Priority」で、これがツリーの頂点として選ばれる優先度とります。
これはRoot Priorityと呼ばれており「値が低いほうが優先される」というルールがあります。
今回はルートスイッチも自分自身もデフォルト値である「32769」となっています。
この値は4096(作成できるVLANの数)の倍数で設定でき、32769は「4096x8」です。
同じプライオリティのスイッチが複数ある場合はその下にある機器を特定するための「Address」の値も使って、ルートスイッチを決めます。
ただ、明示的にPriorityを設定してルートスイッチを決めますので、通常はAddressは気にする必要がありません。
仕組みとしては複雑ですが、ルートスイッチにしたいスイッチに「4096」を与え、
その次の「8192」をルートスイッチのバックアップとなるスイッチに与えます。
正しい物理構成を作り、STPのプロトコルをRSTPかMSTに変更して、
コアスイッチのルートプライオリティを下げる(優先度をあげる)だけで、全てが整います。
なお、見て分かるようにコアスイッチ1がルートスイッチになっておらず、アクセス側がルートスイッチになってしまっています。
設定を加える前はデフォルト値でルートスイッチが決まってしまうので仕方がありません。

後半にある以下の表示はスイッチのポートの状態を示します。

```
Interface           Role Sts Cost      Prio.Nbr Type
------------------- ---- --- --------- -------- --------------------------------
Gi0/1               Desg FWD 4         128.2    P2p
Gi0/2               Root FWD 4         128.3    P2p
Gi0/3               Desg FWD 4         128.4    P2p
```

左側からインターフェース、ロール(Role)、ステータス(Sts)となっています。
そこから右にリンクのコスト等と続くのですが、
規則性を持った正しい物理配線設計をしていればこれらはさほど気にする必要はありません。

Roleには重要なものが2つあり、Root(ルートポート)が「ルートスイッチが存在する側のポート(上流)」で、
Desg(デジグネイテッドポート)が下流側です。
StsはFWD(フォワード)とBLK(ブロック)及び「学習中のステータス(障害からの復旧するために経路を作り直し)」が存在します。
FWDとなっているリンクはスパニングツリーの木構造に組み込まれておりフレームを流しますが、
BLKだとループを防ぐために管理系の通信(CDPやSTPの構築に使うものなど)以外は全てのフレームを送信することも受信することもありません。

実際に機器に設定を加えます。
まず全てのスイッチでSTPのプロトコルをRSTPに変更します。
そしてVLAN1はコアスイッチ1をプライマリにし、コアスイッチ2をバックアップにします。
つまり、コアスイッチ1のroot priorityを4096にし、コアスイッチ2のプライオリティを8192とします。
VLAN2はそれとは逆にコアスイッチ1をバックアップにし、コアスイッチ2をプライマリにします。

```
L2CS1(config)#spanning-tree mode rapid-pvst
L2CS2(config)#spanning-tree mode rapid-pvst
L2AS1(config)#spanning-tree mode rapid-pvst
L2AS2(config)#spanning-tree mode rapid-pvst

L2CS1(config)#spanning-tree vlan 1 priority 4096
L2CS1(config)#spanning-tree vlan 2 priority 8192

L2CS2(config)#spanning-tree vlan 1 priority 8192
L2CS2(config)#spanning-tree vlan 2 priority 4096
```

上記の設定を加えるとコアスイッチ1がVLAN1のルートになります。

```
L2CS1#show spanning-tree vlan 1

VLAN0001
  Spanning tree enabled protocol ieee
  Root ID    Priority    4097
             Address     5e00.0004.0000
             This bridge is the root
             Hello Time   2 sec  Max Age 20 sec  Forward Delay 15 sec

  Bridge ID  Priority    4097   (priority 4096 sys-id-ext 1)
             Address     5e00.0004.0000
             Hello Time   2 sec  Max Age 20 sec  Forward Delay 15 sec
             Aging Time  300 sec

Interface           Role Sts Cost      Prio.Nbr Type
------------------- ---- --- --------- -------- --------------------------------
Gi0/1               Desg FWD 4         128.2    P2p
Gi0/2               Desg FWD 4         128.3    P2p
Gi0/3               Desg FWD 4         128.4    P2p
```

Root ID の箇所に「This bridge is the root」とあります。
また、インターフェースの状態を見ると自分自身がルートスイッチですので、
ルートスイッチに接続するルートポートが一切ないことが分かります。

VLAN2のスパニングツリーの状態をコアスイッチ1で確認すると、
コアスイッチ2側のポートがルートポートになっており、自分自身のプライオリティが8192となっていることがわかります。
8192はこのネットワークのなかで2番目に優先される値ですので、仮にコアスイッチ2が停止をすれば、
それに代わってコアスイッチ1がルートスイッチになります。

```
L2CS1#show spanning-tree vlan 2

VLAN0002
  Spanning tree enabled protocol ieee
  Root ID    Priority    4098
             Address     5e00.0005.0000
             Cost        4
             Port        2 (GigabitEthernet0/1)
             Hello Time   2 sec  Max Age 20 sec  Forward Delay 15 sec

  Bridge ID  Priority    8194   (priority 8192 sys-id-ext 2)
             Address     5e00.0004.0000
             Hello Time   2 sec  Max Age 20 sec  Forward Delay 15 sec
             Aging Time  300 sec

Interface           Role Sts Cost      Prio.Nbr Type
------------------- ---- --- --------- -------- --------------------------------
Gi0/1               Root FWD 4         128.2    P2p
Gi0/2               Desg FWD 4         128.3    P2p
Gi0/3               Desg FWD 4         128.4    P2p
```

次に下流に存在するアクセススイッチのツリーの状態を確認してみます。
着目して欲しいのはポートの状態です。

```
L2AS1#show spanning-tree vlan 1

VLAN0001
  Spanning tree enabled protocol ieee
  Root ID    Priority    4097
             Address     5e00.0004.0000
             Cost        4
             Port        2 (GigabitEthernet0/1)
             Hello Time   2 sec  Max Age 20 sec  Forward Delay 15 sec

  Bridge ID  Priority    32769  (priority 32768 sys-id-ext 1)
             Address     5e00.0002.0000
             Hello Time   2 sec  Max Age 20 sec  Forward Delay 15 sec
             Aging Time  300 sec

Interface           Role Sts Cost      Prio.Nbr Type
------------------- ---- --- --------- -------- --------------------------------
Gi0/1               Root FWD 4         128.2    P2p
Gi0/2               Altn BLK 4         128.3    P2p
Gi0/3               Desg FWD 4         128.4    P2p
```

ルートスイッチに接続されるG0/1がルートポートになり、
PCに接続されるG0/3はデジグネイテッドポートになっています。
一方、コアスイッチ2に接続されるポートのロールが「Altn」となり、状態がブロックであることがわかります。
木構造を見ればルートスイッチに接続される経路はコアスイッチ1への直結経路と、
コアスイッチ2を経由する経路があります。
ルートスイッチまでの「累積コスト」が小さい直結経路をスパニングツリーは使いますので、
このポートは使われない役割「alternate(代替)」としてブロック状態にします。

ここからはわざと機器を再起動させたりインターフェースをダウンさせたりして、
冗長構成を使って通信が復旧することと、
ツリーの形がどのように変わるかということを確認します。


```
L2AS1#
*Nov  1 23:45:34.809: %LINEPROTO-5-UPDOWN: Line protocol on Interface GigabitEthernet0/1, changed state to down
*Nov  1 23:45:35.808: %LINK-3-UPDOWN: Interface GigabitEthernet0/1, changed state to down
L2AS1#show clock
*23:45:42.770 UTC Wed Nov 1 2017
L2AS1#show span
L2AS1#show spanning-tree vl
L2AS1#show spanning-tree vlan 1

VLAN0001
  Spanning tree enabled protocol ieee
  Root ID    Priority    4097
             Address     5e00.0004.0000
             Cost        4
             Port        2 (GigabitEthernet0/1)
             Hello Time   2 sec  Max Age 20 sec  Forward Delay 15 sec

  Bridge ID  Priority    32769  (priority 32768 sys-id-ext 1)
             Address     5e00.0002.0000
             Hello Time   2 sec  Max Age 20 sec  Forward Delay 15 sec
             Aging Time  300 sec

Interface           Role Sts Cost      Prio.Nbr Type
------------------- ---- --- --------- -------- --------------------------------
Gi0/1               Root FWD 4         128.2    P2p
Gi0/2               Altn BLK 4         128.3    P2p
Gi0/3               Desg FWD 4         128.4    P2p
```

```
L2AS1#show clock               
*23:45:54.275 UTC Wed Nov 1 2017
L2AS1#show spanning-tree vlan 1

VLAN0001
  Spanning tree enabled protocol ieee
  Root ID    Priority    4097
             Address     5e00.0004.0000
             Cost        8
             Port        3 (GigabitEthernet0/2)
             Hello Time   2 sec  Max Age 20 sec  Forward Delay 15 sec

  Bridge ID  Priority    32769  (priority 32768 sys-id-ext 1)
             Address     5e00.0002.0000
             Hello Time   2 sec  Max Age 20 sec  Forward Delay 15 sec
             Aging Time  300 sec

Interface           Role Sts Cost      Prio.Nbr Type
------------------- ---- --- --------- -------- --------------------------------
Gi0/1               Desg FWD 4         128.2    P2p
Gi0/2               Root LIS 4         128.3    P2p
Gi0/3               Desg FWD 4         128.4    P2p
```

```
Interface           Role Sts Cost      Prio.Nbr Type
------------------- ---- --- --------- -------- --------------------------------
Gi0/1               Desg FWD 4         128.2    P2p
Gi0/2               Root LRN 4         128.3    P2p
Gi0/3               Desg FWD 4         128.4    P2p
```

```
Interface           Role Sts Cost      Prio.Nbr Type
------------------- ---- --- --------- -------- --------------------------------
Gi0/1               Desg FWD 4         128.2    P2p
Gi0/2               Root FWD 4         128.3    P2p
Gi0/3               Desg FWD 4         128.4    P2p
```

STP VS RSTP

PC1#ping ip 10.0.1.102 repeat 10000 timeout 1
Type escape sequence to abort.
Sending 10000, 100-byte ICMP Echos to 10.0.1.102, timeout is 1 seconds:
!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!
!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!
!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!
!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!
!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!...
....................................................!!!!!!!!!!!!!!!!!!
!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!
!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!


L2CS1(config)#spanning-tree mode rapid-pvst
L2CS2(config)#spanning-tree mode rapid-pvst


L2CS1#show spanning-tree vlan 1

VLAN0001
  Spanning tree enabled protocol rstp
  Root ID    Priority    4097

pingの落ちる時間

PC1#ping ip 10.0.1.102 repeat 10000 timeout 1
Type escape sequence to abort.
Sending 10000, 100-byte ICMP Echos to 10.0.1.102, timeout is 1 seconds:
!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!
!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!
!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!
!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!
!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!
!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!
!!!!!!!!!!!!!!!.....................................!!!!!!!!!!!!!!!!!!
!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!
!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!


スパニングツリーの設定は多岐に渡るため本書でカバーしきれませんが、
ただあえてひとつだけあげるとすれば「スパニングツリーが不要なポートがある」ということです。
先にお話したようにスパニングツリーはL2ネットワーク内でループを作ることを防ぐための技術です。
逆にいえばスイッチに接続されないPCやサーバーと接続されるポートは一般的にループすることはないため、
スパニングツリーを使う理由はありません。

そのようなポートではスパニングツリーの機能を無効化します。
具体的には「spanning-tree portfast」コマンドでステータスを常にフォワードにします。
そして「spanning-tree bpdufilter enable」と「spanning-tree bpduguard enable」コマンドで、
スパニングツリーのやりとりのためのフレームを出さないようにし、受け取らないようにもします。
今回は設定していませんが、ループガードなどの設定を加えることも多いです。

```
L2AS1(config)#int range g0/3,g1/0
L2AS1(config-if-range)#spanning-tree portfast
%Warning: portfast should only be enabled on ports connected to a single
 host. Connecting hubs, concentrators, switches, bridges, etc... to this
 interface  when portfast is enabled, can cause temporary bridging loops.
 Use with CAUTION
L2AS1(config-if-range)#spanning-tree bpdufilter enable
L2AS1(config-if-range)#spanning-tree bpduguard enable
```

ユーザーがアクセススイッチの下に勝手にスイッチを追加したりしないように注意をしてください。
ネットワークに詳しいユーザーであれば大きな問題はおこさないでしょうが、
詳しくないユーザーが管理者の目が届かないところでループ構成を作ってしまうといった可能性があります。
そうした場合に「ネットワーク全体に影響が及ぶことを防ぐために、
そのポートを自動でシャットダウンさせる」という設定も検討すべきです。

## HSRP, VRRP

PCが自分自身が属するネットワーク以外に通信するには、デフォルトゲートウェイにパケットを転送します。
このデフォルトゲートウェイとなる機器に障害が発生しても問題がないように、デフォルトゲートウェイにも冗長化手法があります。

デフォルトゲートウェイの冗長化手法は主にCisco固有のプロトコルであるHSRPと、
ベンダーに依存しないVRRPというプロトコルが使われます。
他にもいくつか存在する類似プロトコルも含んで、FHRP(First Hop Redundancy Protocol)と総称されています。
一般的にFHRPを使う機材は同一ベンダの同一機種でそろえます。
そのため、ベンダー間の相性などは気にする必要はないため、今回はCisco機器で利用するHSRPを使用します。

HSRPを使ったデフォルトゲートウェイの冗長化は、
2台のL3スイッチもしくはルーターがゲートウェイとなる同一のIPを共有することで実現されます。
先ほどのスパニングツリーと同じように、優先度が高いプライマリ側がゲートウェイとして動作し、
プライマリに障害が発生した場合にバックアップ側がゲートウェイとして動作をします。
ゲートウェイを利用するPCとしては、プライマリ側を使っていようと、バックアップ側を使っていようと、
デフォルトゲートウェイのIP宛に送って転送してくれさえすれば構いません。

なお、HSRPを構成する2台の機器にL2レベルで到達できないとどうしようもないため、
HSRPはスパニングツリーもしくは他のL2冗長化技術と組み合わせて利用されます。
本書では基本のスパニングツリー構成を使います。

以下にHSRPの仕組みの概念図を記載します。

<<図>>

HSRPを構成する2台の機器のIPインターフェース(ほとんどL3スイッチのSVIです)には、
物理IPと仮想IP(VIP, Virtual IP)が与えられます。
2台の機器とも物理IPは常に通信できる状態ですが、HSRPで共有されている仮想IPはアクティブな側しか利用しません。
そのため、デフォルトゲートウェイ宛の通信はHSRPのアクティブ側に届けられます。
(もう少し技術的に説明をするのであれば、仮想IPにもMACアドレスが存在し、アクティブな側がARPに応答します。
そのVIPのMACアドレス宛の通信はMACテーブルに従ってアクティブ側に届けられ、
仮に中間経路にスタンバイ側がいたとしても、それは素通りさせるという動きをします。)

以上のようにHSRPには「仮想IPの指定」と「プライオリティ」の指定が必要であることが分かります。
他に重要なものとしては「プリエンプト」と呼ばれるもので、
バックアップ側が動いている際にプライマリ側が復活した際にどのような挙動をするかが決まります。
デフォルトではプリエンプトが無効になっており、プライマリ側(優先度が高い)はアクティブを取り戻すことはありません。
つまりバックアップ側が仮想IPを持ち続けて、デフォルトゲートウェイとして動作を続けるということです。
一方、プリエンプトの設定を有効にすると、プライマリ側が復活した際にアクティブになり、デフォルトゲートウェイとして動作するようになります。

スパニングツリーのルート側をHSRPのアクティブ側にすると余計なコアスイッチ間の転送が抑えられるため、
先ほどのスパニングツリーの構成に以下のようなHSRPの設定を加えます。

<<図>>

コアスイッチ1がVLAN1のルートスイッチであるため、VLAN1のSVIでHSRPのプライオリティをあげます。
逆に、VLAN2のルートスイッチであるコアスイッチ2側では、VLAN2のSVIでHSRPのプライオリティをあげます。
デフォルトのプライオリティは100で、値が高いほどプライオリティが高くなります。
理屈的には不要ですが、「バックアップ側である」ということを強調するためにプライマリ側でないSVIのプライオリティには95を設定しています。
そしてプリエンプとを有効にしています。
バックアップ側がアクティブを取り戻すというシナリオはないため、バックアップ側には必ずしもプリエンプトの設定は必要ありません。

それでは設定を行いましょう。



デフォルトゲートウェイとしして動作をする


同一ネットワーク内の通信を冗長化


 - 分かりやすいIPにする
 - Active/Standby
 - Preempt

## L3経路(OSPF)の冗長化

1つのルーターやスイッチ(L3でルーティング)の故障が発生しても、
異なるネットワーク間での転送が継続できるべきです。
複数のネットワークを繋ぐルーティング機器を冗長化することで、これが実現できます。

実はL3経路の冗長化は既に第3章の「経路選択」にて扱っています。
複数の経路からどれか1本の利用経路を選ぶということは、
その経路が使えなくなっても代替経路を使えるということです。
ただ、代替経路をやみくもに作っても完全に冗長化を取ることが難しく、
なおかつ経路を新しく算出するためのやりとりや計算に時間がかかると復旧が遅くなります。

ここでは第三章の経路選択で利用したものよりも、
より現実的な「スパイン/リーフ」と呼ばれる構成でL3経路の冗長化を実現します。

<<図>>

今まで扱ってきた「アクセス層とコア層」の構成を冗長化されたL3機器で接続します。
図ではコア層のスイッチ間をL3スイッチが繋いでいますが、この接続は第4章で扱ったルーテッドポートを使っています。
そのため、L2転送は全く利用されず、コアスイッチとバックボーンスイッチ間は全てルーティング処理されます。

図を見てもらうとわかりますが、「10.1.0.0/24」のネットワークと「10.2.0.0」への通信経路は、
バックボーンに出ていく出口(HSRPを利用)も、バックボーンから入ってくる入口もそれぞれ二重化されています。
そして各エリアの2つのコアスイッチは2つのバックボーンのスイッチへ接続していますので、
どこかのリンクが落ちたり機器が停止しても通信経路が確保されます。

この構成の良いところは、2台のコアスイッチとバックボーンスイッチを接続する4本のリンクの全てで、
通信コストを同一にすれば「等コストロードバランス」と呼ばれる機能が使える点です。
この機能は「ある宛先にいける経路が複数あれば、その全て(上限はある)を使う」というものです。
どのパケットをどの経路に振り分けるかは先に紹介したチャネルのポート分散の仕組みと大差ありません。
なお、この機能が使えるかどうかは機器に依存しますが、多くのCiscoのルーターやスイッチはサポートしています。

後ほど改めて確認しますが、
例えば上記図のコアスイッチ1では以下のようなルーティングテーブルが作成されます。

```
O IA     10.2.0.0/24 [110/3] via 10.0.2.1, 00:02:13, GigabitEthernet1/0
                     [110/3] via 10.0.0.1, 00:02:13, GigabitEthernet0/3
```

これは「10.0.2.0/24」というネットワークに行くために、
バックボーンスイッチ1(10.0.2.1)とバックボーンスイッチ(10.0.0.1)にロードバランスさせるという状態です。

ロードバランスさせるので複数の経路の帯域の合計値を使えるという分かりやすいメリットもありますが、
リンクや機器の障害で1つの経路がなくなっても、
もう一つの経路にすぐに切り替えられるというメリットがあります。
例えばバックボーンスイッチ1(10.0.0.1)経由のパスを通っていたものの、
そのスイッチが落ちてその経路を失えば、残るバックボーンスイッチ2(10.0.2.1)の経路に即座に切り替えます。

以下の構成で設定を行い、実際に障害を発生させて疎通性の確認をします。

<<図>>

まずPC1からPC2まで、どのような経路でパケットが通過するか確認します。
最初に通過する機器はHSRPのActive側であるCSW1-1になりますが、
その後に通過するスイッチはロードバランスの結果次第です。

ネットワークを跨ぐ通信ですので、tracerouteコマンドを使って選ばれる経路を確認します。

```
PC1#traceroute 10.2.0.102
Type escape sequence to abort.
Tracing the route to 10.2.0.102
VRF info: (vrf in name/id, vrf out name/id)
  1 10.1.0.2 10 msec 14 msec 12 msec
  2 10.0.0.1 12 msec 8 msec 15 msec
  3 10.0.5.2 32 msec 29 msec 25 msec
  4 10.2.0.102 25 msec 21 msec *
```

最初の1ホップめは予想通りCSW1-1となっています。
通過するIPはHSRPのVIPではなく、物理IPになっています(これが期待される挙動です)。
2ホップめはBBSW1となり、3ホップめがCSW2-2で、4ホップめで宛先であるPC2に到達しています。

このとき通過するL3スイッチで、
宛先ネットワークである「10.2.0.0/24」は以下のような形でルーティングテーブルに登録されています。

```
CSW1-1のエントリ  
O IA     10.2.0.0/24 [110/3] via 10.0.2.1, 00:02:13, GigabitEthernet1/0
                     [110/3] via 10.0.0.1, 00:02:13, GigabitEthernet0/3

BBSW1のエントリ
O IA     10.2.0.0/24 [110/2] via 10.0.5.2, 00:04:34, GigabitEthernet1/0
                     [110/2] via 10.0.4.2, 00:04:34, GigabitEthernet0/3
```

期待通り、等コストロードバランスできる状態となっています。
それではPC1からPC2へ通信をしている状態で、通過するBBSW1をリロードして通信障害を発生させてみます。

```
PC1#ping 10.2.0.102 repeat 100000 timeout 1
Type escape sequence to abort.
Sending 100000, 100-byte ICMP Echos to 10.2.0.102, timeout is 1 seconds:
!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!
<省略>
!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!...!!!!!!!!!!!!
<省略>
!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!.
Success rate is 99 percent (940/944), round-trip min/avg/max = 10/24/106 ms
```

pingの出力を見ると分かるように、およそ3秒ほど不通の状態が続きましたが、
すぐに通信が回復しています。

BBSW1にパケットを届けられなくなったCSW-1のルーティングテーブルを見ると、
もうひとつの経路であるBBSW2経由は残っているため、こちらを使い続けることができます。

```
CSW1-1のエントリ
O IA     10.2.0.0/24 [110/3] via 10.0.2.1, 00:12:10, GigabitEthernet1/0
```

しばらく待ってBBSW1が復旧し、OSPFによる経路情報のやりとりが終了すると、
ルーティングテーブルは元のように等コストロードバランスできる状態に戻りました。

```
復旧後のエントリ
O IA     10.2.0.0/24 [110/3] via 10.0.2.1, 00:14:26, GigabitEthernet1/0
                     [110/3] via 10.0.0.1, 00:01:40, GigabitEthernet0/3
```


## コラム : ベンダ特有の冗長化技術

ここからはネットワークの基礎ではないものの、
実際の企業ネットワークを構築するのに関わる冗長化技術を紹介します。
Ciscoの製品をベースに解説を行いますが、他のベンダーでも類似製品を出していますので大差はありません。

## ブロック型とシャーシ型



## Stack
## VSS, MLAG(VPC)
## Trill
