# L2/3の冗長化技術

企業のネットワークが停止するということは仕事に大きな支障が発生します。
パッと思いつくのはインターネットに繋がらなかったら不便ということかもしれませんが、
現在の多くの企業は社内システムをIT化していますので、
たとえば店舗などでは商品発注や在庫管理などができなくなってしまいます。

今までお話してきた第二章から第四章までの構成は、機器の故障を一切考慮していません。
試しに機器を「reload」コマンドで再起動してみると、再起動している間の通信は全く通らなくなります。
家のPCや家電が壊れるように、企業が使っているネットワーク機器も壊れますので、
「1つの機器が壊れたら社内ネットワークが使えなくなります」という構成は許容されません。

この一箇所壊れたら使えなくなる箇所は「SPOF(Single Point Of Failure)」と呼ばれており、
ネットワークの冗長化技術を使うことでSPOFの数を可能な限り減らすことが必要です。
本章ではこの冗長化技術をリンクレベル、L2レベル、L3レベルで順に扱います。

なお、全てを冗長化する必要がないことは認識する必要があります。
例えばノートPCのネットワークのポートは1つしかないため、そこを冗長化することはしません。
今だったら無線Lanがあるので、それで冗長化になっているかもしれませんが。
また、信頼性がさほど必要のない検証環境では、とにかく安く抑えるためにスイッチなどのインフラを冗長化をしないという場合もあります。
商用環境ではないので落ちたところで不便以上の大きな影響はないため、壊れたらベンダーの保守契約で翌日交換などすれば問題なしという姿勢です。
コストと信頼性の優劣は資金や環境によって異なりますので、適切な冗長化レベルを選択する必要があります。


## Spanning Tree

チャネルを使うことで機器間のリンクを冗長化することはできました。
ただ、ケーブルやポートが壊れることがあるのと同じように、スイッチ自体が壊れたり停止(再起動)すべき状況になったりする場合もあります。
そのような状況はチャネルでは救えないため、L2の機器同士の接続も冗長化する必要があります。
これを実現する手法な様々ですが、最も一般的なものが「STP(Spanning Tree Protocol)」を使って、接続を冗長化するというものです。

詳細なSTPの仕組みは後ほど説明しますが、以下の2つの構成(VLAN1しかないとします)を見比べるだけでも、
機器自体を冗長化する必要性が分かるのではないでしょうか。

<<図>>

今まで用いてきた構成ですと

ただ、第二章で学んだスイッチの動きを思い出して下さい。
スイッチがブロードキャストフレーム(ARPなど)や、MAC学習していないユニキャストフレームを受け取った場合は、
それを同一のVLANのポート(今回は図の全て)に全てフラッディングするという動きをするのでした。
上記のように接続されている状況でフラッドされるフレームが発生すると、
例えば以下のようにARPパケットがフラッディング(1入力N出力)を繰り返して、
フレーム数を増やしながらぐるぐるとループし続けてしまいます。
こうなってしまいますと、そのフレームがネットワークのトラフィックを埋め尽くして、ネットワーク障害が発生します。

<<図>>

スパニングツリープロトコルは「冗長化をしつつ、L2ループを防ぐ」ための技術です。
より具体的にいうと、図左のような冗長性を持った接続であっても右側のようなL2の通信経路を作り、
障害が起きると新しい通信経路に切り替えることで通信を継続させます。
ループが発生できないL2ネットワークの形は「木構造」です。
スパニング「ツリー」という名前からも分かるように、このプロトコルは複数のスイッチ同士でお互いに会話をして、
木構造のL2ネットワークを構築します。

どのように情報をやりとりしているか説明をするまえに、実際に障害時にどのように経路が切り替わるのか説明しましょう。
例えばスイッチ自体に障害が発生した場合は以下の図のように障害に対処します。

<<図>>

木構造の頂点(ルート)のスイッチが故障により停止したため、頂点を隣にある冗長化のためのスイッチに切り替えています。
この切替はスイッチ同士の会話が絡むため数秒から数十秒ほど時間がかかりますが、
それでも4時間配送(ベンダーの保守契約)の交換作業を待ったり、人手でバックアップ機器に取り替えるより素早く障害から復旧します。

スイッチ自体に問題がなくても、リンクが切れてしまった場合も通信経路のパスを切り替えることもできます。
例えば以下のシナリオではツリーの頂点(ルート)は同じままで木構造が変化しています。

<<図>>

この木構造の構築ですが、基本的には以下のルールを覚えれば十分です。

1. ツリーの頂点(ルート)に選ばれるのは最もプライオリティが高いスイッチ
2. 頂点から末端にかけて帯域が広いリンクを優先してパスを作る
3. ルート側のポートが上流、それ以外が下流
4. ルートまでの到達するポートが複数ある場合は、到達コスト(通る経路のコストの足し算)が最も高いリンク以外はブロックする

試験対策などであればより詳細なルールを覚える必要がありますが、
一般的にL2ネットワークは「物理構成に階層を作り、複雑さを減らす」という構成をとります。
そのような状況下ではツリーの構造が明確なため、スパニングツリーのアルゴリズムの詳細を知らなくても構造が把握できます。
具体的には以下のような構成を取るのが鉄板です。

1. 上流スイッチ(コア層)と下層スイッチ(アクセス層)の2階層構造とする
2. 上流のスイッチは冗長化して互いに接続する。コア層を3台以上にすることはほぼない。
3. 上流の階層にあるプライマリとなるスイッチのプライオリティをあげる
4. プライマリのバックアップとなるスイッチを2番目のプライオリティにする
5. 下流にいるスイッチ群のプライオリティはデフォルト値(低い)のままで問題ない。
6. 下流にあるスイッチ同士はお互いに接続をしない
7. サーバーなどの重要な機器は2つのアクセス層のスイッチに接続する(脱線するためコラムで扱う)

下流にあるスイッチ同士をお互いに接続したほうが、
それに繋がるPC同士の通信が近そうな気がするかもしれません。
ただ、そのリンクはスパニングツリープロトコルでブロックされるため、どうせ使われません。
2台の上流スイッチの両方が死んだ時はもう外に通信できない状況ですので、
その状況で下流スイッチ同士の通信は考慮しなくて構いません。
サーバーなどはアクセス層のスイッチの障害にそなえるために2つのアクセス層のスイッチに接続したりしますが、

規模によってはアクセス層とコア層の2階層ではなく、
アクセス制御のための「ディストリビューション層」を間に挟む3階層にする場合があります。
ただ、機器のパフォーマンスが向上しているので2階層構成にして、
それ以上になる場合はネットワークを切る構成のほうが昨今だといいかもしれません。

長くなりましたが、上記条件を満たす以下のトポロジーを使ってスパニングツリーの設定を行い、
障害時の挙動を確認します。

<<図>>

スパニングツリーはVLANごとに設定できます。
つまり、VLANごとにツリーの構造を変えられるということです。
コアスイッチ1を全てのVLANのルートとして使ってもいいのですが、
負荷分散させる目的でVLAN1のルートをコアスイッチ1にし、VLAN2のルートをコアスイッチ2にします。
VLANごとに設定範囲が異なる可能性があるため誤差はあるでしょうが、
ツリーの形は「どちらのコアスイッチをルートにするか」で決まるため、
おおまかには2種類しか存在しません。

L2及びL3スイッチでスパニングツリープロトコルはデフォルトで有効になっています。
設定を加える前にスパニングツリーの状態を「show spanning-tree」コマンドで確認します。

```
L2CS1#show spanning-tree

VLAN0001
  Spanning tree enabled protocol ieee
  Root ID    Priority    32769
             Address     5e00.0002.0000
             Cost        4
             Port        3 (GigabitEthernet0/2)
             Hello Time   2 sec  Max Age 20 sec  Forward Delay 15 sec

  Bridge ID  Priority    32769  (priority 32768 sys-id-ext 1)
             Address     5e00.0004.0000
             Hello Time   2 sec  Max Age 20 sec  Forward Delay 15 sec
             Aging Time  300 sec

Interface           Role Sts Cost      Prio.Nbr Type
------------------- ---- --- --------- -------- --------------------------------
Gi0/1               Desg FWD 4         128.2    P2p
Gi0/2               Root FWD 4         128.3    P2p
Gi0/3               Desg FWD 4         128.4    P2p

<以下省略(VLAN2の情報が続く)>
```

このコマンドでは大まかに利用しているSTPの種類、
ルートスイッチ及び自分自身の「ルートになるためのプライオリティ値」と、
自分自身のポートの状態が分かります。

VLAN番号の後に表示されている「Spanning tree enabled protocol ieee」がSTPのプロトコルです。
Ciscoの機器ではSTP(PVSTとも呼ばれる), RSTP(Rappid STP), MSTの3つが使われており、ieeeはデフォルトのPVSTです。
RSTPはのほうが障害時の収束がSTPよりも高速であるため、特別な理由がない限りRSTPを利用して下さい。
MSTはRSTPの亜種でVLANをグループ化して設定できます。
VLAN数が多い場合は「設定をシンプル化」「スイッチ間の会話を減らす」ためにMSTを使ってください。
今回はVLANが2つしかないため、後ほどRSTPに変更をします。
あたりまえですが、同じセグメントにいる全ての機器でプロトコルは統一してください。

「Root ID」で表示されている情報がルートスイッチのもので、その下の「Bridge ID」が自分自身のものです。
全て重要な情報なのですが、最も大事なのは「Priority」で、これがツリーの頂点として選ばれる優先度とります。
これはRoot Priorityと呼ばれており「値が低いほうが優先される」というルールがあります。
今回はルートスイッチも自分自身もデフォルト値である「32769」となっています。
この値は4096(作成できるVLANの数)の倍数で設定でき、32769は「4096x8」です。
同じプライオリティのスイッチが複数ある場合はその下にある機器を特定するための「Address」の値も使って、ルートスイッチを決めます。
ただ、明示的にPriorityを設定してルートスイッチを決めますので、通常はAddressは気にする必要がありません。
仕組みとしては複雑ですが、ルートスイッチにしたいスイッチに「4096」を与え、
その次の「8192」をルートスイッチのバックアップとなるスイッチに与えます。
正しい物理構成を作り、STPのプロトコルをRSTPかMSTに変更して、
コアスイッチのルートプライオリティを下げる(優先度をあげる)だけで、全てが整います。
なお、見て分かるようにコアスイッチ1がルートスイッチになっておらず、アクセス側がルートスイッチになってしまっています。
設定を加える前はデフォルト値でルートスイッチが決まってしまうので仕方がありません。

後半にある以下の表示はスイッチのポートの状態を示します。

```
Interface           Role Sts Cost      Prio.Nbr Type
------------------- ---- --- --------- -------- --------------------------------
Gi0/1               Desg FWD 4         128.2    P2p
Gi0/2               Root FWD 4         128.3    P2p
Gi0/3               Desg FWD 4         128.4    P2p
```

左側からインターフェース、ロール(Role)、ステータス(Sts)となっています。
そこから右にリンクのコスト等と続くのですが、
規則性を持った正しい物理配線設計をしていればこれらはさほど気にする必要はありません。

Roleには重要なものが2つあり、Root(ルートポート)が「ルートスイッチが存在する側のポート(上流)」で、
Desg(デジグネイテッドポート)が下流側です。
StsはFWD(フォワード)とBLK(ブロック)及び「学習中のステータス(障害からの復旧するために経路を作り直し)」が存在します。
FWDとなっているリンクはスパニングツリーの木構造に組み込まれておりフレームを流しますが、
BLKだとループを防ぐために管理系の通信(CDPやSTPの構築に使うものなど)以外は全てのフレームを送信することも受信することもありません。

実際に機器に設定を加えます。
まず全てのスイッチでSTPのプロトコルをRSTPに変更します。
そしてVLAN1はコアスイッチ1をプライマリにし、コアスイッチ2をバックアップにします。
つまり、コアスイッチ1のroot priorityを4096にし、コアスイッチ2のプライオリティを8192とします。
VLAN2はそれとは逆にコアスイッチ1をバックアップにし、コアスイッチ2をプライマリにします。

```
L2CS1(config)#spanning-tree mode rapid-pvst
L2CS2(config)#spanning-tree mode rapid-pvst
L2AS1(config)#spanning-tree mode rapid-pvst
L2AS2(config)#spanning-tree mode rapid-pvst

L2CS1(config)#spanning-tree vlan 1 priority 4096
L2CS1(config)#spanning-tree vlan 2 priority 8192

L2CS2(config)#spanning-tree vlan 1 priority 8192
L2CS2(config)#spanning-tree vlan 2 priority 4096
```

上記の設定を加えるとコアスイッチ1がVLAN1のルートになります。

```
L2CS1#show spanning-tree vlan 1

VLAN0001
  Spanning tree enabled protocol ieee
  Root ID    Priority    4097
             Address     5e00.0004.0000
             This bridge is the root
             Hello Time   2 sec  Max Age 20 sec  Forward Delay 15 sec

  Bridge ID  Priority    4097   (priority 4096 sys-id-ext 1)
             Address     5e00.0004.0000
             Hello Time   2 sec  Max Age 20 sec  Forward Delay 15 sec
             Aging Time  300 sec

Interface           Role Sts Cost      Prio.Nbr Type
------------------- ---- --- --------- -------- --------------------------------
Gi0/1               Desg FWD 4         128.2    P2p
Gi0/2               Desg FWD 4         128.3    P2p
Gi0/3               Desg FWD 4         128.4    P2p
```

Root ID の箇所に「This bridge is the root」とあります。
また、インターフェースの状態を見ると自分自身がルートスイッチですので、
ルートスイッチに接続するルートポートが一切ないことが分かります。

VLAN2のスパニングツリーの状態をコアスイッチ1で確認すると、
コアスイッチ2側のポートがルートポートになっており、自分自身のプライオリティが8192となっていることがわかります。
8192はこのネットワークのなかで2番目に優先される値ですので、仮にコアスイッチ2が停止をすれば、
それに代わってコアスイッチ1がルートスイッチになります。

```
L2CS1#show spanning-tree vlan 2

VLAN0002
  Spanning tree enabled protocol ieee
  Root ID    Priority    4098
             Address     5e00.0005.0000
             Cost        4
             Port        2 (GigabitEthernet0/1)
             Hello Time   2 sec  Max Age 20 sec  Forward Delay 15 sec

  Bridge ID  Priority    8194   (priority 8192 sys-id-ext 2)
             Address     5e00.0004.0000
             Hello Time   2 sec  Max Age 20 sec  Forward Delay 15 sec
             Aging Time  300 sec

Interface           Role Sts Cost      Prio.Nbr Type
------------------- ---- --- --------- -------- --------------------------------
Gi0/1               Root FWD 4         128.2    P2p
Gi0/2               Desg FWD 4         128.3    P2p
Gi0/3               Desg FWD 4         128.4    P2p
```

次に下流に存在するアクセススイッチのツリーの状態を確認してみます。
着目して欲しいのはポートの状態です。

```
L2AS1#show spanning-tree vlan 1

VLAN0001
  Spanning tree enabled protocol ieee
  Root ID    Priority    4097
             Address     5e00.0004.0000
             Cost        4
             Port        2 (GigabitEthernet0/1)
             Hello Time   2 sec  Max Age 20 sec  Forward Delay 15 sec

  Bridge ID  Priority    32769  (priority 32768 sys-id-ext 1)
             Address     5e00.0002.0000
             Hello Time   2 sec  Max Age 20 sec  Forward Delay 15 sec
             Aging Time  300 sec

Interface           Role Sts Cost      Prio.Nbr Type
------------------- ---- --- --------- -------- --------------------------------
Gi0/1               Root FWD 4         128.2    P2p
Gi0/2               Altn BLK 4         128.3    P2p
Gi0/3               Desg FWD 4         128.4    P2p
```

ルートスイッチに接続されるG0/1がルートポートになり、
PCに接続されるG0/3はデジグネイテッドポートになっています。
一方、コアスイッチ2に接続されるポートのロールが「Altn」となり、状態がブロックであることがわかります。
木構造を見ればルートスイッチに接続される経路はコアスイッチ1への直結経路と、
コアスイッチ2を経由する経路があります。
ルートスイッチまでの「累積コスト」が小さい直結経路をスパニングツリーは使いますので、
このポートは使われない役割「alternate(代替)」としてブロック状態にします。

ここからはわざと機器を再起動させたりインターフェースをダウンさせたりして、
冗長構成を使って通信が復旧することと、
ツリーの形がどのように変わるかということを確認します。


```
L2AS1#
*Nov  1 23:45:34.809: %LINEPROTO-5-UPDOWN: Line protocol on Interface GigabitEthernet0/1, changed state to down
*Nov  1 23:45:35.808: %LINK-3-UPDOWN: Interface GigabitEthernet0/1, changed state to down
L2AS1#show clock
*23:45:42.770 UTC Wed Nov 1 2017
L2AS1#show span
L2AS1#show spanning-tree vl
L2AS1#show spanning-tree vlan 1

VLAN0001
  Spanning tree enabled protocol ieee
  Root ID    Priority    4097
             Address     5e00.0004.0000
             Cost        4
             Port        2 (GigabitEthernet0/1)
             Hello Time   2 sec  Max Age 20 sec  Forward Delay 15 sec

  Bridge ID  Priority    32769  (priority 32768 sys-id-ext 1)
             Address     5e00.0002.0000
             Hello Time   2 sec  Max Age 20 sec  Forward Delay 15 sec
             Aging Time  300 sec

Interface           Role Sts Cost      Prio.Nbr Type
------------------- ---- --- --------- -------- --------------------------------
Gi0/1               Root FWD 4         128.2    P2p
Gi0/2               Altn BLK 4         128.3    P2p
Gi0/3               Desg FWD 4         128.4    P2p
```

```
L2AS1#show clock               
*23:45:54.275 UTC Wed Nov 1 2017
L2AS1#show spanning-tree vlan 1

VLAN0001
  Spanning tree enabled protocol ieee
  Root ID    Priority    4097
             Address     5e00.0004.0000
             Cost        8
             Port        3 (GigabitEthernet0/2)
             Hello Time   2 sec  Max Age 20 sec  Forward Delay 15 sec

  Bridge ID  Priority    32769  (priority 32768 sys-id-ext 1)
             Address     5e00.0002.0000
             Hello Time   2 sec  Max Age 20 sec  Forward Delay 15 sec
             Aging Time  300 sec

Interface           Role Sts Cost      Prio.Nbr Type
------------------- ---- --- --------- -------- --------------------------------
Gi0/1               Desg FWD 4         128.2    P2p
Gi0/2               Root LIS 4         128.3    P2p
Gi0/3               Desg FWD 4         128.4    P2p
```

```
Interface           Role Sts Cost      Prio.Nbr Type
------------------- ---- --- --------- -------- --------------------------------
Gi0/1               Desg FWD 4         128.2    P2p
Gi0/2               Root LRN 4         128.3    P2p
Gi0/3               Desg FWD 4         128.4    P2p
```

```
Interface           Role Sts Cost      Prio.Nbr Type
------------------- ---- --- --------- -------- --------------------------------
Gi0/1               Desg FWD 4         128.2    P2p
Gi0/2               Root FWD 4         128.3    P2p
Gi0/3               Desg FWD 4         128.4    P2p
```

STP VS RSTP

PC1#ping ip 10.0.1.102 repeat 10000 timeout 1
Type escape sequence to abort.
Sending 10000, 100-byte ICMP Echos to 10.0.1.102, timeout is 1 seconds:
!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!
!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!
!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!
!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!
!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!...
....................................................!!!!!!!!!!!!!!!!!!
!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!
!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!


L2CS1(config)#spanning-tree mode rapid-pvst
L2CS2(config)#spanning-tree mode rapid-pvst


L2CS1#show spanning-tree vlan 1

VLAN0001
  Spanning tree enabled protocol rstp
  Root ID    Priority    4097

pingの落ちる時間

PC1#ping ip 10.0.1.102 repeat 10000 timeout 1
Type escape sequence to abort.
Sending 10000, 100-byte ICMP Echos to 10.0.1.102, timeout is 1 seconds:
!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!
!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!
!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!
!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!
!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!
!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!
!!!!!!!!!!!!!!!.....................................!!!!!!!!!!!!!!!!!!
!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!
!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!


スパニングツリーの設定は多岐に渡るため本書でカバーしきれませんが、
ただあえてひとつだけあげるとすれば「スパニングツリーが不要なポートがある」ということです。
先にお話したようにスパニングツリーはL2ネットワーク内でループを作ることを防ぐための技術です。
逆にいえばスイッチに接続されないPCやサーバーと接続されるポートは一般的にループすることはないため、
スパニングツリーを使う理由はありません。

そのようなポートではスパニングツリーの機能を無効化します。
具体的には「spanning-tree portfast」コマンドでステータスを常にフォワードにします。
そして「spanning-tree bpdufilter enable」と「spanning-tree bpduguard enable」コマンドで、
スパニングツリーのやりとりのためのフレームを出さないようにし、受け取らないようにもします。
今回は設定していませんが、ループガードなどの設定を加えることも多いです。

```
L2AS1(config)#int range g0/3,g1/0
L2AS1(config-if-range)#spanning-tree portfast
%Warning: portfast should only be enabled on ports connected to a single
 host. Connecting hubs, concentrators, switches, bridges, etc... to this
 interface  when portfast is enabled, can cause temporary bridging loops.
 Use with CAUTION
L2AS1(config-if-range)#spanning-tree bpdufilter enable
L2AS1(config-if-range)#spanning-tree bpduguard enable
```

ユーザーがアクセススイッチの下に勝手にスイッチを追加したりしないように注意をしてください。
ネットワークに詳しいユーザーであれば大きな問題はおこさないでしょうが、
詳しくないユーザーが管理者の目が届かないところでループ構成を作ってしまうといった可能性があります。
そうした場合に「ネットワーク全体に影響が及ぶことを防ぐために、
そのポートを自動でシャットダウンさせる」という設定も検討すべきです。
