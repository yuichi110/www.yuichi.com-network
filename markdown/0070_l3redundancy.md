# L3冗長化

## 概要

## FHRP(First Hop Redundancy Protocol)

STPを使ったL2冗長化技術を使って同一ネットワーク内の通信ができるようになったとしても、
そのネットワークの出口となるゲートウェイが停止してしまえば外と通信ができなくなります。
そのため、ゲートウェイも冗長化をする必要があります。


HSRP, VRRP

PCが自分自身が属するネットワーク以外に通信するには、デフォルトゲートウェイにパケットを転送します。
このデフォルトゲートウェイとなる機器に障害が発生しても問題がないように、デフォルトゲートウェイにも冗長化手法があります。

デフォルトゲートウェイの冗長化手法は主にCisco固有のプロトコルであるHSRPと、
ベンダーに依存しないVRRPというプロトコルが使われます。
他にもいくつか存在する類似プロトコルも含んで、FHRP(First Hop Redundancy Protocol)と総称されています。
一般的にFHRPを使う機材は同一ベンダの同一機種でそろえます。
そのため、ベンダー間の相性などは気にする必要はないため、今回はCisco機器で利用するHSRPを使用します。

HSRPを使ったデフォルトゲートウェイの冗長化は、
2台のL3スイッチもしくはルーターがゲートウェイとなる同一のIPを共有することで実現されます。
先ほどのスパニングツリーと同じように、優先度が高いプライマリ側がゲートウェイとして動作し、
プライマリに障害が発生した場合にバックアップ側がゲートウェイとして動作をします。
ゲートウェイを利用するPCとしては、プライマリ側を使っていようと、バックアップ側を使っていようと、
デフォルトゲートウェイのIP宛に送って転送してくれさえすれば構いません。

なお、HSRPを構成する2台の機器にL2レベルで到達できないとどうしようもないため、
HSRPはスパニングツリーもしくは他のL2冗長化技術と組み合わせて利用されます。
本書では基本のスパニングツリー構成を使います。

以下にHSRPの仕組みの概念図を記載します。

<<図>>

HSRPを構成する2台の機器のIPインターフェース(ほとんどL3スイッチのSVIです)には、
物理IPと仮想IP(VIP, Virtual IP)が与えられます。
2台の機器とも物理IPは常に通信できる状態ですが、HSRPで共有されている仮想IPはアクティブな側しか利用しません。
そのため、デフォルトゲートウェイ宛の通信はHSRPのアクティブ側に届けられます。
(もう少し技術的に説明をするのであれば、仮想IPにもMACアドレスが存在し、アクティブな側がARPに応答します。
そのVIPのMACアドレス宛の通信はMACテーブルに従ってアクティブ側に届けられ、
仮に中間経路にスタンバイ側がいたとしても、それは素通りさせるという動きをします。)

以上のようにHSRPには「仮想IPの指定」と「プライオリティ」の指定が必要であることが分かります。
他に重要なものとしては「プリエンプト」と呼ばれるもので、
バックアップ側が動いている際にプライマリ側が復活した際にどのような挙動をするかが決まります。
デフォルトではプリエンプトが無効になっており、プライマリ側(優先度が高い)はアクティブを取り戻すことはありません。
つまりバックアップ側が仮想IPを持ち続けて、デフォルトゲートウェイとして動作を続けるということです。
一方、プリエンプトの設定を有効にすると、プライマリ側が復活した際にアクティブになり、デフォルトゲートウェイとして動作するようになります。

スパニングツリーのルート側をHSRPのアクティブ側にすると余計なコアスイッチ間の転送が抑えられるため、
先ほどのスパニングツリーの構成に以下のようなHSRPの設定を加えます。

<<図>>

コアスイッチ1がVLAN1のルートスイッチであるため、VLAN1のSVIでHSRPのプライオリティをあげます。
逆に、VLAN2のルートスイッチであるコアスイッチ2側では、VLAN2のSVIでHSRPのプライオリティをあげます。
デフォルトのプライオリティは100で、値が高いほどプライオリティが高くなります。
理屈的には不要ですが、「バックアップ側である」ということを強調するためにプライマリ側でないSVIのプライオリティには95を設定しています。
そしてプリエンプとを有効にしています。
バックアップ側がアクティブを取り戻すというシナリオはないため、バックアップ側には必ずしもプリエンプトの設定は必要ありません。

それでは設定を行いましょう。



デフォルトゲートウェイとしして動作をする


同一ネットワーク内の通信を冗長化


 - 分かりやすいIPにする
 - Active/Standby
 - Preempt

## L3経路(OSPF)の冗長化

1つのルーターやスイッチ(L3でルーティング)の故障が発生しても、
異なるネットワーク間での転送が継続できるべきです。
複数のネットワークを繋ぐルーティング機器を冗長化することで、これが実現できます。

実はL3経路の冗長化は既に第3章の「経路選択」にて扱っています。
複数の経路からどれか1本の利用経路を選ぶということは、
その経路が使えなくなっても代替経路を使えるということです。
ただ、代替経路をやみくもに作っても完全に冗長化を取ることが難しく、
なおかつ経路を新しく算出するためのやりとりや計算に時間がかかると復旧が遅くなります。

ここでは第三章の経路選択で利用したものよりも、
より現実的な「スパイン/リーフ」と呼ばれる構成でL3経路の冗長化を実現します。

<<図>>

今まで扱ってきた「アクセス層とコア層」の構成を冗長化されたL3機器で接続します。
図ではコア層のスイッチ間をL3スイッチが繋いでいますが、この接続は第4章で扱ったルーテッドポートを使っています。
そのため、L2転送は全く利用されず、コアスイッチとバックボーンスイッチ間は全てルーティング処理されます。

図を見てもらうとわかりますが、「10.1.0.0/24」のネットワークと「10.2.0.0」への通信経路は、
バックボーンに出ていく出口(HSRPを利用)も、バックボーンから入ってくる入口もそれぞれ二重化されています。
そして各エリアの2つのコアスイッチは2つのバックボーンのスイッチへ接続していますので、
どこかのリンクが落ちたり機器が停止しても通信経路が確保されます。

この構成の良いところは、2台のコアスイッチとバックボーンスイッチを接続する4本のリンクの全てで、
通信コストを同一にすれば「等コストロードバランス」と呼ばれる機能が使える点です。
この機能は「ある宛先にいける経路が複数あれば、その全て(上限はある)を使う」というものです。
どのパケットをどの経路に振り分けるかは先に紹介したチャネルのポート分散の仕組みと大差ありません。
なお、この機能が使えるかどうかは機器に依存しますが、多くのCiscoのルーターやスイッチはサポートしています。

後ほど改めて確認しますが、
例えば上記図のコアスイッチ1では以下のようなルーティングテーブルが作成されます。

```
O IA     10.2.0.0/24 [110/3] via 10.0.2.1, 00:02:13, GigabitEthernet1/0
                     [110/3] via 10.0.0.1, 00:02:13, GigabitEthernet0/3
```

これは「10.0.2.0/24」というネットワークに行くために、
バックボーンスイッチ1(10.0.2.1)とバックボーンスイッチ(10.0.0.1)にロードバランスさせるという状態です。

ロードバランスさせるので複数の経路の帯域の合計値を使えるという分かりやすいメリットもありますが、
リンクや機器の障害で1つの経路がなくなっても、
もう一つの経路にすぐに切り替えられるというメリットがあります。
例えばバックボーンスイッチ1(10.0.0.1)経由のパスを通っていたものの、
そのスイッチが落ちてその経路を失えば、残るバックボーンスイッチ2(10.0.2.1)の経路に即座に切り替えます。

以下の構成で設定を行い、実際に障害を発生させて疎通性の確認をします。

<<図>>

まずPC1からPC2まで、どのような経路でパケットが通過するか確認します。
最初に通過する機器はHSRPのActive側であるCSW1-1になりますが、
その後に通過するスイッチはロードバランスの結果次第です。

ネットワークを跨ぐ通信ですので、tracerouteコマンドを使って選ばれる経路を確認します。

```
PC1#traceroute 10.2.0.102
Type escape sequence to abort.
Tracing the route to 10.2.0.102
VRF info: (vrf in name/id, vrf out name/id)
  1 10.1.0.2 10 msec 14 msec 12 msec
  2 10.0.0.1 12 msec 8 msec 15 msec
  3 10.0.5.2 32 msec 29 msec 25 msec
  4 10.2.0.102 25 msec 21 msec *
```

最初の1ホップめは予想通りCSW1-1となっています。
通過するIPはHSRPのVIPではなく、物理IPになっています(これが期待される挙動です)。
2ホップめはBBSW1となり、3ホップめがCSW2-2で、4ホップめで宛先であるPC2に到達しています。

このとき通過するL3スイッチで、
宛先ネットワークである「10.2.0.0/24」は以下のような形でルーティングテーブルに登録されています。

```
CSW1-1のエントリ  
O IA     10.2.0.0/24 [110/3] via 10.0.2.1, 00:02:13, GigabitEthernet1/0
                     [110/3] via 10.0.0.1, 00:02:13, GigabitEthernet0/3

BBSW1のエントリ
O IA     10.2.0.0/24 [110/2] via 10.0.5.2, 00:04:34, GigabitEthernet1/0
                     [110/2] via 10.0.4.2, 00:04:34, GigabitEthernet0/3
```

期待通り、等コストロードバランスできる状態となっています。
それではPC1からPC2へ通信をしている状態で、通過するBBSW1をリロードして通信障害を発生させてみます。

```
PC1#ping 10.2.0.102 repeat 100000 timeout 1
Type escape sequence to abort.
Sending 100000, 100-byte ICMP Echos to 10.2.0.102, timeout is 1 seconds:
!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!
<省略>
!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!...!!!!!!!!!!!!
<省略>
!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!.
Success rate is 99 percent (940/944), round-trip min/avg/max = 10/24/106 ms
```

pingの出力を見ると分かるように、およそ3秒ほど不通の状態が続きましたが、
すぐに通信が回復しています。

BBSW1にパケットを届けられなくなったCSW-1のルーティングテーブルを見ると、
もうひとつの経路であるBBSW2経由は残っているため、こちらを使い続けることができます。

```
CSW1-1のエントリ
O IA     10.2.0.0/24 [110/3] via 10.0.2.1, 00:12:10, GigabitEthernet1/0
```

しばらく待ってBBSW1が復旧し、OSPFによる経路情報のやりとりが終了すると、
ルーティングテーブルは元のように等コストロードバランスできる状態に戻りました。

```
復旧後のエントリ
O IA     10.2.0.0/24 [110/3] via 10.0.2.1, 00:14:26, GigabitEthernet1/0
                     [110/3] via 10.0.0.1, 00:01:40, GigabitEthernet0/3
```


## コラム : ベンダ特有の冗長化技術

ここからはネットワークの基礎ではないものの、
実際の企業ネットワークを構築するのに関わる冗長化技術を紹介します。
Ciscoの製品をベースに解説を行いますが、他のベンダーでも類似製品を出していますので大差はありません。

## ブロック型とシャーシ型



## Stack
## VSS, MLAG(VPC)
## Trill
