# ルーティングプロトコルを使った経路学習

## 概要


## スタティックルートとダイナミックルート

### スタティックルートの欠点

小中規模のオフィスで数台のルーターを使うような場合は、
スタティックルートでルーティングを制御することでネットワーク間の通信を制御をできます。

ただ、大きな組織で多数のネットワークが複雑に構成される場合は、
スタティックルートを使って人の手で経路情報を制御することは困難な場合が多いです。
例えば100台のルーターが複雑に接続されていて、
1000個のネットワークがそこに存在する環境を想像してください。
全てのルーターを手動で設定することは非常に労力がかかり、
なおかつネットワークの変更や追加作業は複雑なものとなることが分かります。

人間のオペレーションにはミスが伴いますので、
複雑になればなるほど人手による設定は信頼できなくなります。


### ルーティングプロトコルを使ったダイナミックルート

スタティックルートの煩雑さを解消するために「**ルーティングプロトコル**」が使われます。
ルーティングプロトコルはルーターの間で会話をするための言語のようなもので、
隣り合う機器同士で「私はネットワークAに接続されています」「私はネットワークBに接続されています」といった情報をやりとりします。
各機器は交換した情報にもとづいて「ネットワークAにパケットを送るにはルーターR1にパケットを転送する」
といったことを知り、それにもとづいてルーティングテーブルを自動で構築します。

人間がトポロジ図を見てネットワークの構成を把握してスタティックルートを書くように、
ルーターが互いに会話してネットワークの構成を把握してルーティングテーブルのエントリを作成するのです。
ルーティングプロトコルがどのような地図を作成し、それをどうルーティングテーブルのエントリにするかはプロトコルに依存します。

![image](./0035_image/01.png)

注意をしてほしいのは「ルーター同士が交換する情報」と「ルーティングテーブルのエントリ」は別物ということです。
ルーティングプロトコルはネットワークとネットワークがどのように接続されているかという「地図」を作ります。
その地図を見れば、ある宛先あてのパケットをどちらに送ればいいかという判断ができるため、
それをルーティングテーブルに書き込みます。
パケットの転送には地図(トポロジ情報)は用いられず、
地図を見て作られた道路標識のようなルーティングテーブルのエントリが使われます。

ルーティングプロトコルを使って学習した経路情報は「**ダイナミックルート**」と呼ばれており、
宛先ネットワークに辿り着くためのルートが状況に応じて適切なものに修正されます。
たとえば上記の図ではR2が停止をすればR1は10.2.0.0/16にたどり着くルートを失うため、
ルーティングテーブルからそのエントリを失います。
ただ、仮に10.2.0.0/16にたどり着くための別の経路があるとすれば、
R2が停止したあとでもそれを使って10.2.0.0/16に通信を継続することができます。
一方、スタティックルートであれば相手の状態に関係なくパケットを転送し続けますので、
途中の経路で問題などが起きていても、その経路を使い続けようとします。

なお、ルーティングプロトコルを使った自動的な経路学習と、
スタティックルートを使った人手による経路設定は同時に使うことができます。
よく見られるのが東京オフィスと大阪オフィスの間のような拠点間でのルーティングにはスタティックルートを使い、
各拠点の内部ではダイナミックルートを使うといった構成です。


### ルーティングプロトコルの種類

ルーティングプロトコルにはいくつかの種類があります。
それぞれのプロトコルごとに動作方法や利用目的などが異なっていますが、
大きく分類すると「組織内で使われるプロトコル」と「組織間(つまりインターネット)で使われるプロトコル」の2種類があります。

組織内で使われるプロトコルとは、
ようするにある会社や団体(学校など)の内部ネットワークとして使われるプロトコルということです。
その組織内にIT管理者がいて、その人達が責任を持って管理運用を行うことができます。
組織内で使われるプロトコルは総称として「**IGP(Interior Gateway Protocol)**」と呼ばれており、
最も標準的なものが「**OSPF**」と呼ばれるプロトコルです。
他には「**RIP**」「**EIGRP**」「**ISIS**」といったものがあります。

どのように機器間で情報を交換してネットワークの地図を構築し、
それをどのようにしてルーティングテーブルのエントリにするかということはプロトコルに依存しています。
ただ、RIPは「**ディスタンスベクタ**」と呼ばれる仕組みで、
隣接機器同士の伝言でネットワーク情報を推測してルーティングテーブルのエントリを作るのに対し、
OSPFやISISは「**リンクステート**」と呼ばれる仕組みでネットワーク内の全ての機器の情報を把握して、
それを計算することでネットワーク構造を把握してルーティングテーブルのエントリを作成します。
前者のほうが処理が簡単なため昔から使われていますが、後者のほうが正確さがあり障害時の復旧が早いため現在は後者(特にOSPF)が主流となっています。

一方、組織間で使われるプロトコルはA社とB社の間といった管理者が異なる複数のネットワーク間で使われるプロトコルということです。
両方の組織の管理者の間で「こうしましょうね」という取り決めを結ぶことが必須で、
それにしたがってお互いに機器を設定して組織間でのパケット転送をするための経路情報を交換しあいます。
組織間でのルーティングに使われるプロトコルは「**EGP(Exterior Gateway Protocol)**」と呼ばれており、
現在使われているプロトコルは「**BGP**」のみです。

BGPを利用するのはサービスプロバイダーやキャリアと呼ばれる「別の組織にネットワークを提供する組織」がほとんどです。
一部の多国籍企業や大企業などでもBGPを利用することがありますが、
多くの組織は「**ISP(インターネットサービスプロバイダー)**」が提供するインターネットの回線を使うだけですので、
自分でBGPを使って他社と接続するということはしません。
これは品質や保証帯域などを除けば自宅のインターネット回線の利用法と大差はありません。

以下にIGPとEGPが利用される箇所を図に示します。

![image](./0035_image/02.png)

つまり、ISPやキャリアなどを除く一般的な企業に勤めるネットワークエンジニアであれば、
OSPFさえ理解していればネットワークは問題なく構築できる場合がほとんどです。


## OSPFを使った経路学習

### トポロジ

ルーティングプロトコルを使った動的な経路学習の題材はなんでもよいのですが、
本ページでは主流であるOSPFを利用します。
ただ、OSPFがどう動いているかということよりも、
勝手に経路情報(ルーティングテーブルのエントリ)が作成されるということが主体となるため、
OSPFの詳細については設定に関わる必要最低限を除いて割愛します。

以下のようなネットワークを題材にして機器に設定を加え、
どのようなルーティングテーブルが構築されるか確認します。

![image](./0035_image/03.png)

構成としては中央に10.0.0.0/16のネットワークがあり、
それに他のネットワークがぶら下がっています。
ルーターR1,R2,R3はそれぞれ隣接しているため、
お互いが持つネットワークの情報を直接交換できます。
一方、R4はR3のみと接続しているため、R1とR2はR4が持つネットワーク情報をR3経由で学びます。
同様にR4はR1とR2が持つネットワーク情報をR3経由で学びます。


### OSPFの動作説明(簡易版)

細かな仕組みはそれぞれのルーティングプロトコルに依存していますが、
ルーティングプロトコルを使ったルーティングテーブルの構築はルーター間の情報の伝達で実現されています。
たとえば「ネットワークAはこっちにあるよ」「私はネットワークBに接続しています」といった情報を、
バケツリレーのように多数のルーターで共有して各ルーターがルーティングテーブルを構築しています。
大まかに言ってしまえばディスタンスベクタ型は隣の機器同士で情報を伝言ゲームのように伝える仕組みで動き、
OSPFのようなリンクステート型は全ての機器の情報を共有しあうという仕組みで動いています。

多くのルーティングプロトコルでは隣接機器同士でやりとりするために「**ネイバー関係**」を結びます。
各機器で「このインターフェースの先(L2)に存在する機器とやりとりします」
「このIPを持つ機器とやりとりします」などと設定することで結ばれ、
ネイバー関係にない機器とは情報のやりとりをしません。

OSPFでネイバー関係が結ばれると、自分が持つリンクステート(どのネットワークに繋がっているかという情報)だけでなく、
他の機器からもらったリンクステート情報を別の機器にも渡します。
これを繰り返すことで自分が直接ネイバー関係を結んでいない機器の情報も知ることができ、
ネットワークの全体像を各機器が把握します。

![image](./0035_image/04.png)

各ルーターが伝え合うそれぞれのルーターが接続しているネットワークの情報は、
組織内のネットワーク全体の断片情報です。
それらを全て正しくつなぎ合わせることで組織内のネットワーク構造の全体図を作ることができます。

この全体図は全てのルーターが同じものを持つので、
あるネットワークに辿り着くためのルーターAが考える転送方法とルーターBが考える転送方法は同じです。
全員が同じ認識を持った上で、各機器が自分が果たすべき転送をルーティンテーブルのエントリという形にするので、
全てのルーターが連携してパケットを宛先ネットワークまで届けることができるようになります。

OSPFのおおまかな仕組みは上記のようなものですが、
これに加えて経路情報を交換するグループである「**エリア**」という概念があります。
OSPFは全てのルーターの情報を交換し合うので、台数が増えれば増えるほど交換するデータ量が増えて、
ネットワークの構造を計算するコストが増大します。
エリアを使って機器をグループすることにより、それらを抑えることができます。

OSPFにおいて中心となるエリアは「0」で、
それに他のエリアが直接接続されるという構造となります。
単純なトポロジであればエリア分けをする必要はなく、その場合は全てのルーターをエリア0に属するように設定します。


### OSPFの設定

先のトポロジ図にもとづいてルーターR1からR4にOSPFの設定を加えていきます。

OSPFを使うには、ルーターでOSPFのプロセスを作成することから始めます。
ルーターのプロセス作成はグローバル設定モードで「**router ospf <プロセス番号>**」とします。
1つのルーター上で複数のOSPFプロセスを走らせることができるためプロセス番号の指定がありますが、
通常は1つのプロセスしか走らせません。
ここではプロセス番号を1とします。

```text
R1(config)#router ospf 1
R1(config-router)#exit
```

「router ospf」コマンドを発行することでOSPF設定モードに移行して、細かいOSPF設定などができます。
ネイバー関係を張って経路交換するだけであれば設定不要ですので、exitコマンドですぐに抜けています。

ルーターレベルでOSPFを有効化したので、各インターフェース上でOSPFを有効化をします。
こうすることで、そのインターフェースがOSPFによるリンクステートの管理対象に入わり、
隣接する他のOSPFルーターとネイバー関係を結ぶようになります。

インターフェースでOSPFを有効化するには「**ip ospf <プロセス番号> area <エリア番号>**」というコマンドを使います。
プロセス番号は先ほど作成したプロセス1を使い、エリア番号はエリアを分けないため0を指定します。

```text
R1(config)#int g0/1
R1(config-if)#ip ospf 1 area 0
R1(config-if)#int g0/2
R1(config-if)#ip ospf 1 area 0
```

OSPFが有効になったインターフェースからは、
マルチキャストを使ったOSPFの「**Helloパケット**」が送信されるようになります。
L2ネットワークにおいてマルチキャストパケットはブロードキャストパケットと同じように全ての機器に届けられます。
そのため、同一ネットワークに属する別のOSPFのルーターに届けられ、互いに存在を知ってネイバーを結びことができます。

他のルーターR2,R3,R4を設定して、R1のOSPFネイバーをshowコマンドで確認します。
ネイバーの確認には「**show ip ospf neighbor**」コマンドを使います。

```text
R1#show ip ospf neighbor

Neighbor ID     Pri   State           Dead Time   Address         Interface
10.0.99.2         1   FULL/BDR        00:00:34    10.0.99.2       GigabitEthernet0/2
10.0.99.3         1   FULL/DROTHER    00:00:31    10.0.99.3       GigabitEthernet0/2
```

Neighborとして隣接しているR2及びR3が表示されています。
一方、同一ネットワークに存在しないR4はネイバーとはなっていません。

もしネイバーがうまく形成できない場合は「**show ip ospf interface brief**」などで、
きちんとインターフェースがOSPFの対象に含まれているか確認をしてください。

```text
R1#show ip ospf interface brief
Interface    PID   Area            IP Address/Mask    Cost  State Nbrs F/C
Gi0/2        1     0               10.0.99.1/24       1     DR    2/2
Gi0/1        1     0               10.0.1.1/24        1     DR    0/0
```

ネイバーが結ばれれば、ルーター間でネットワークの情報(リンクステート)のやりとりが開始されて、
勝手にネットワーク全体像を構築してルーティングテーブルにエントリとして書き込まれるようになります。


### OSPFによる経路学習

OSPFで学習した経路もルーティングテーブルのエントリに記載されます。
「show ip route」コマンドを使うと、OSPFで学んだ経路は「O」というコードとともに表示されています。

```text
R1#show ip route
Codes: L - local, C - connected, S - static, R - RIP, M - mobile, B - BGP
       D - EIGRP, EX - EIGRP external, O - OSPF, IA - OSPF inter area
       N1 - OSPF NSSA external type 1, N2 - OSPF NSSA external type 2
       E1 - OSPF external type 1, E2 - OSPF external type 2
       i - IS-IS, su - IS-IS summary, L1 - IS-IS level-1, L2 - IS-IS level-2
       ia - IS-IS inter area, * - candidate default, U - per-user static route
       o - ODR, P - periodic downloaded static route, H - NHRP, l - LISP
       a - application route
       + - replicated route, % - next hop override, p - overrides from PfR

Gateway of last resort is not set

      10.0.0.0/8 is variably subnetted, 7 subnets, 2 masks
C        10.0.1.0/24 is directly connected, GigabitEthernet0/1
L        10.0.1.1/32 is directly connected, GigabitEthernet0/1
O        10.0.2.0/24 [110/2] via 10.0.99.2, 00:09:01, GigabitEthernet0/2
O        10.0.3.0/24 [110/2] via 10.0.99.3, 00:00:37, GigabitEthernet0/2
O        10.0.4.0/24 [110/2] via 10.0.99.3, 00:00:37, GigabitEthernet0/2
C        10.0.99.0/24 is directly connected, GigabitEthernet0/2
L        10.0.99.1/32 is directly connected, GigabitEthernet0/2
```

OSPFで学んだ経路情報のみを表示するには「show ip route ospf」コマンドを使います。

```text
R1#show ip route ospf
Codes: L - local, C - connected, S - static, R - RIP, M - mobile, B - BGP
       D - EIGRP, EX - EIGRP external, O - OSPF, IA - OSPF inter area
       N1 - OSPF NSSA external type 1, N2 - OSPF NSSA external type 2
       E1 - OSPF external type 1, E2 - OSPF external type 2
       i - IS-IS, su - IS-IS summary, L1 - IS-IS level-1, L2 - IS-IS level-2
       ia - IS-IS inter area, * - candidate default, U - per-user static route
       o - ODR, P - periodic downloaded static route, H - NHRP, l - LISP
       a - application route
       + - replicated route, % - next hop override, p - overrides from PfR

Gateway of last resort is not set

      10.0.0.0/8 is variably subnetted, 7 subnets, 2 masks
O        10.0.2.0/24 [110/2] via 10.0.99.2, 00:31:06, GigabitEthernet0/2
O        10.0.3.0/24 [110/2] via 10.0.99.3, 00:22:42, GigabitEthernet0/2
O        10.0.4.0/24 [110/2] via 10.0.99.3, 00:22:42, GigabitEthernet0/2
```

ルーターR1は隣接するルーターR2,R3が持つインターフェースに対する経路情報だけでなく、
直接接続しないR4の先にある経路の情報まで持っていることが分かります。
これはルーターR4とは直接情報交換していないものの、R3がR4の情報も伝えているためです。
R3から伝えられたR4のリンクステートをもとに、R1はR4の状況を知り、
それがルーティングテーブルに反映されています。
