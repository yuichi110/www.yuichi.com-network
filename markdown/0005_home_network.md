# 自宅のネットワークの仕組み

{{ TOC }}

## 概要


## はじめに

一般的な家のネットワークでは「家の中」と「家の外」しか区別がありません。
このようなシンプルな構成はネットワークを本格的に学ぶ題材としては不十分ですが、
身の回りにある機器ですので想像しやすいかと思います。

本章では自宅にある一般的な家庭用のルーター(ブロードバンドルーターと呼ばれる)やPCなどを通して、ネットワークの概要について学びます。
次章からは実際にシミュレーターを使ってCiscoの機器の操作をしますが、やっていることの本質は本章で学ぶことと大差ありません。

## アプリケーションとネットワーク

ブラウザやメールソフトといったアプリケーションは、ネットワークを使って他の機器とつながります。
このときに自分のPCの中がどう動いているかについて本セクションで説明します。

ブラウザ

WindowsやMac、スマホのiosやandroidといったOSはどれも「TCP/IP」と呼ばれるネットワークの仕組みを持っています。
日本語しか知らない日本人と英語しか知らないアメリカ人の会話がなりたたないように、
機器同士も共有する言葉がないとお互いに会話することができません。
「TCP/IP」は機器同士が通信をする際の共通語です。
全員が同じTCP/IPのルールに従うことで、複数の機器がお互いに通信できるようになっています。

TCP/IPの詳細は難しいため、本腰を入れて学ぶのはもう少し後にしますが、ここではいちばん重要なコンセプトのみを学びます。

アクセスしたサーバーのウェブサーバーアプリケーションと通信をやりとりしています。
ネットワークはこのPCとサーバーを繋ぐITインフラで、今後お話するルーターやスイッチといったネットワーク機器で作られています。


Windowsやiphoneが提供するネットワークの機能を利用しており、
同様にウェブページを提供するウェブサーバー側もWindowsサーバーやLinuxのネットワーク機能を使っています。

<<図>>

TCP/IPのプロトコル・スタック
カプセル化
ポート番号

## インターネットの仕組みとIPアドレス

多くの読者のかたの自宅には無線LAN(wifi)のルーターやPCなどがあると思います。
まずはこれらの機材がどのようにして、様々なウェブページ(Yahooなど)に接続しているかという仕組みについて扱います。

インターネット(Internet)という単語は「Inter Network」に由来しています。
この「Inter」は「中間」という意味を持っていますので、Internetを日本語に直訳すると「ネットワークの中間」ともいえます。
YahooやGoogleといった組織は会社やサービスのネットワークをそれぞれ持っていて、それをインターネットが接続します。
たとえばYahooのページに行きたければ、インターネットを通って自宅のPCがYahooのサーバーに接続し、ウェブページの情報を取得します。

ただ、これは自宅のPCがインターネットに接続しているという前提でなりたっています。
インターネットを経由して様々なウェブページにアクセスするので、
自宅のPCがインターネットに繋がっていないとどうしようもありません。

多くのかたがNTTやサービスプロバイダー(OCNやSo-netなど)とインターネット接続の契約を結んだ経験があると思いますが、
これは自宅のPCをインターネットに繋げるために行っています。
繋ぎかたには様々な方法がありますが、日本で最も主流なのは「NTTの回線を使ってサービスプロバイダーに接続する」という形式です。

ご存知のようにNTTは固定電話のための回線を提供することを主なビジネスとしていました(今は違います)。
電力会社が電信柱を経由して家庭に電力を供給するのと同じように、NTTも電信柱を使って家庭に電話回線を提供していました。
現在は多くのエリアで電話回線から光ファイバーに置き換えられていますが、このNTTが持つ物理的な回線を使って、
家とサービスプロバイダーを接続しています。

家にあるPCはこのサービスプロバイダーのネットワークに接続されます。
そしてインターネットを経由して、サービスプロバイダーのネットワークからYahooやGoogleのネットワークにあるサーバーに接続するのです。

スマホがインターネットを使えるのもこれと似た仕組みで、NTTの光ファイバの代わりに無線でDocomoなどに接続し、
Docomoを経由してインターネットに出ていきます。
この仕組を以下の図にまとめます。

<<図>>

このようにして、自分の家のPCや外出時のスマホがインターネットに接続されると、
同じくインターネットに接続されているYahooやGoogle及びその他のウェブサイトと繋がることができるようになります。

ただ、ネットワークで相手(この場合はサーバー)に繋がるには、相手がどこにいるかを指定する必要があります。
これはネットワーク上の住所であるIPアドレスという仕組みを使います。
本書籍を手にとるようなかたであれば、「192.168.0.1」や「10.0.0.1」などというアドレスを見たことがあるのではないでしょうか。
各ドットの区切り(オクテットと呼ばれる)は0から255までありますので、
IPアドレスの組み合わせは「256 x 256 x 256 x 256」個の合計「42億9496万7296」個となります。
(厳密にはこれは正確な表現ではないので、後ほど詳細を扱います。)

インターネットに接続されているネットワークはそれぞれIPアドレスのレンジを持っています。
たとえばYahooのネットワークは「1.0.0.0」から「1.255.255.255」までを持っているとしましょう。
Googleは「2.0.0.0」から「2.255.255.255」であり、サービスプロバイダーは「3.0.0.0」から「3.255.255.255」です。

サービスプロバイダーの中にある自分のPCは、当然ながら「3.0.0.0」から「3.255.255.255」の間のどれか一つのアドレスを持ちます。
今回は「3.0.0.100」としましょう。
それがYahooのサーバー(1.0.0.100とします)と通信しようと思うと、
郵便配達と同じような仕組みで、まずは「1.0.0.0」というYahooのネットワーク自体に通信データ(パケット)を届けようとします。
そしてインターネットを経由してYahooのネットワークにパケットが届いたら、
Yahooのネットワークの中でそれを1.0.0.100のアドレスを持つサーバーに届けます。
これはちょうど、大阪(サービスプロバイダー)の家から東京(Yahoo)の家に荷物を届ける際に、
「まずは東京(Yahoo)の集荷所に荷物が配送され、東京の中で新宿区のXXさんの家に届ける」というような流れに似ています。
Yahooのサーバーから自宅のPC(サービスプロバイダーのネットワーク内)に返信データを届けるときも、
これと同じ仕組みとなります。
なお、パケットの中身の詳細は後ほど扱いますが送信先のアドレスと送信元のアドレス(返信が必要なため)と、
相手に届けるデータ(データグラムと呼ばれる)を持っています。

ここから、IPアドレスにも2つがあることが分かります。
ひとつめがネットワーク自体のアドレスで「ネットワークアドレス」と呼ばれるものです。
そしてもうひとつがネットワーク内に機器(PCやサーバーなどで、まとめて「ホスト」と呼ばれる)を示す「ホストアドレス」です。

Yahooのサーバが持つIPアドレスは、1.0.0.100としましたが、
これはネットワークアドレスだとYAHOOが持つ範囲の始まりである「1.0.0.0」となります。
そしてホストアドレスが「1.0.0.100」です。
パケットを違うネットワークに届ける場合は、ネットワークアドレスを見て、どこに届ける必要があるか判断します。
大阪から東京の新宿区のXXさんの家に荷物を届ける場合は、新宿区というのは無視して、とりあえず東京に送るということです。

<<図>>

このネットワークアドレスとホストアドレスの境界を示すのが「サブネットマスク」や「プレフィックス」と呼ばれる仕組みです。
たとえば「1.100.0.100」と「1.200.0.100」が同じネットワークにあるかどうかは、
ネットワークアドレスが「1.0.0.0 (後ろ3オクテットがホストアドレス)」であるか
「1.100.0.0(後ろ2オクテットがホストアドレス)」であるかによって代わります。
この区切りを示すサブネットマスクでは「255.0.0.0(最初の1オクテットがネットワーク)」や、
「255.255.0.0(最初の2オクテットがネットワーク)」として教えてくれます。
同様にプレフィックスでは「8(最初の1オクテット)」や「16(最初の2オクテット)」と表記します。
これらの表記方法は2進数を使っているため、慣れないと少し難しいかもしれません。
後の章でルーティングの仕組みを詳細に説明しますので、そこでサブネットマスクやプレフィックスの書き方を扱います。

なお、ご存知のようにブラウザでYahooにアクセスする場合はIPアドレスではなく、
「http://www.yahoo.co.jp」などというようにドメイン名でアクセスをします。
これは「DNS(Domain Name System)」という仕組みでドメイン名(www.yahoo.co.jp)をIPアドレス(1.0.0.100)に変換しているためです。
ネームサーバーをIPアドレスで登録しておくと、ドメイン名の解決をそのサーバーに問い合わせてIPアドレスを得ます。

## 家庭用ルーターの仕事

先ほどのようにPCをNTTの回線を使ってサービスプロバイダーに直結することもできますが、
多くの家庭では無線LANルーターを利用しています。

これは家のなかにある複数の機器を全てインターネットに接続するためです。
サービスプロバイダーに繋げるLANポートはおそらく一つだけかと思いますので、
もしそれにPCを直結してしまうと他の機器がネットワークに繋げなくなってしまいます。
ルーターをLANポートに繋ぎ、そのルータを中継地点としてPCやタブレットを無線(もしくはLANケーブルで)で繋げることで、
複数の機器がインターネットを使えるようになります。

実はルーターの役割は「ネットワークを分けること」と「通信(パケット)を正しい宛先に転送する」ことにあります。
先ほどの図ではサービスプロバイダーのネットワークに直接PCが組み込まれていました。
LANポートの数もそうですが、サービスプロバイダーも多数の家にたいしてネットワークを提供しなければいけないため、
一つの家から制限なくたくさんの機器を「直接」接続することはできません。
一つのネットワークの中で使えるIPアドレスの数は決まっています。
たとえばサービスプロバイダーが1000個のアドレスを500世帯に対して提供しているとすれば、
一世帯あたりが3つも4つもアドレスを使うと他の家が必要なアドレスを使えなくなってしまう可能性があります。

家庭用ルータはネットワークの中継をすることで、この問題を解決しています。
「NAT(Network Address Translation)」と呼ばれる仕組みを使って、
サービスプロバイダーから与えられた一つのIPアドレスを複数の機器で共有しています。
具体的にはルーターはサービスプロバイダーに接続するポートにサービスプロバイダーから与えられたIPアドレスである「3.0.0.100」を設定し、
PCやスマホが接続される自宅側のネットワークには新しいネットワーク
(ここでは「192.168.0.0」のネットワークアドレスでサブネットマスクが「255.255.0.0」とします)を作ります。
PCやスマホは「192.168.0.100」や「192.168.0.101」といったホストアドレスを持ち、
同様にルーター自体も「192.168.0.1」といったアドレスを持ちます。

192.168.0.100のアドレスを持つPCがYahooのサーバーと通信をしたい場合は、
まずパケットを192.168.0.1のアドレスを持つルーターに転送をします。
そのパケットを見たルーターは送信元のアドレスをサービスプロバイダー側のIPである「3.0.0.100」に変更し、
それをYahooのサーバーに届け、Yahooのサーバーから返信を得ます。
Yahooからの返信を見たルーターはそれがもともと192.168.0.100から送られたパケットに対する返信だと気づき、
返信パケットの宛先のIPを「3.0.0.100」から「192.168.0.100」に変更します。
このようなアドレス変換をすることで、192.168.0.100のアドレスを持つPCはサーバーと通信することができます。
同じことは192.168.0.101のアドレスを持つスマホがPCと通信をする際にも発生しますので、
インターネットに接続できる「3.0.0.100」というひとつのIPアドレスで、複数の機器をインターネットに接続できます。

<<図>>

家庭用のルーターを使った環境では、PCはルーターが提供する自宅内専用のネットワークに接続します。
このとき、一般的には「DHCP」という仕組みでPCやスマホはIPアドレスをルーターから自動で学習します。
これはPCなどの設定に依存しますが、特に設定を変更していなければWindowsやMacをwifiに接続するか、
LANケーブルでルーターに接続すると「私のIPを下さい」とネットワークに参加する全ての機器に対してリクエストを送ります。
それに気付いたルーターが「あなたのアドレスはこれを使って下さい」といって返信をすることで、
PCは自分のIPアドレスにルーターから伝えられたものを設定します。
このときにIPアドレスだけでなく、ネットワークアドレスの境界を知るためのサブネットマスクや、
インターネットに接続する際にパケットを送る宛先(先ほどの例だと192.168.0.1)となる「デフォルトゲートウェイ」のアドレス、
他には名前解決のためのネームサーバーのIPアドレスといった情報も得ます。
DHCPは自宅に限らず、多くのオフィスや公共施設でのネットワークにも使われています。
Wifiに接続したらすぐにネットワークに繋がるようになるのはDHCPのおかげです。

なお、DHCPを使わずに自分でIPアドレスその他を設定することも可能です。
その際はIPアドレスが他の機器(DHCPも含む)と重複しないように注意をしてください。
IPアドレスが変わると不便なサーバー(例えば自宅NAS)やプリンタなどには固定IPを利用する場合が多いです。

## ルーター(異なるネットワークの機器を繋ぐ)とスイッチ(同じネットワークに複数の機器を繋ぐ)

家庭用ルーターを使ったインターネットへの接続は、ルーターがPCと家の外の世界の通信を仲介するのでした。
ただ、家のPCの通信は必ずしもインターネットを使うとは限りません。
たとえば多くの家庭では自宅内にネットワークに対応したプリンタに対してプリントするデータを送ったり、
動画や写真を保存するNAS(Network Attached Storage)に動画を保存したり、取得したりします。

これらの機器はPCと同じ自宅内のネットワークにあるため、PCと同じネットワークアドレスを持ちます。
ただ、違う機器であるため異なるホストアドレスとなります。

<<図>>

実は「同じネットワーク内の通信」と「異なるネットワーク間の通信」は、
その仕組が若干異なります。
先ほどお話したように、異なるネットワーク(インターネットの先にいるYahooなど)と通信をする場合は、
PCはまず家庭用ルータにパケットを届けて、NAT機能を使って家庭用ルータでアドレスを変換して、
ルータが外のサーバーと通信をするという仕組みでした。
一方、同じネットワーク内の通信は家庭用ルーターは通信を経由するものの、
アドレス変換などはせずに直接PCとプリンタが通信をします。

この仕組は次の章でルーターとスイッチの動きを学ぶまでは少し難しいのですが、
家庭用ルーターが以下のような仕組みになっていると考えれば分かりやすいです。

<<図>>

一般的な家庭用ルーターには以下のネットワークのポートがあります。

 - インターネット側(NTTのモデムなどを繋ぐ)
 - 家庭内側(PCやプリンタを繋ぐ)
 - 無線LAN

家庭内向けの機器のポートは全てスイッチという「同じネットワークに属する機器を繋ぐ機械」で接続されていると考えられます。
これはポートが足りないユーザー向けに製品としても販売されているため、聞いたことがあるかもしれません。
無線LANを提供する機械はアクセスポイントと呼ばれていて、無線版のスイッチと考えてもらうと分かりやすいです。

一方、ルーターは「異なる複数のネットワークを繋ぐ機械」として使われており、
サービスプロバイダー側のネットワークと、自宅のネットワークを繋いでいます。

純粋なルーターやスイッチは上記の図のように役割ごとに機械が異なっています。
ただ、自宅で使われる家庭用ルーター(ブロードバンドルーター)は一つの機械で全ての機能をまかなっています(そのほうが便利で売れるから)。
そのため、ブロードバンドルーターは「ルーター」という名前がついているものの、スイッチとしても使われています。
家庭用だけでなく業務用の機器もルーターとスイッチの機能が一つの機械の中にまとめられていることが多いです。
例えば後ほど紹介するL3スイッチなどはその典型です。
ただ、上記のようにルーターとスイッチを機能として分けて考えると理解がしやすいかもしれません。

同じネットワーク内の通信はスイッチを経由して行われ、ルーターとしての機能は利用されません。
一方、異なるネットワークへの通信はルーターを経由して行われます。
このとき必ずしもスイッチを経由する必要はありませんが、
ルーターはポート数が少なくスイッチが接続される構成をとっていることが多いため、
スイッチを経由してPCとルーターが接続されます。

なお、スイッチを使った同じネットワーク内の通信はIPアドレスではなく、
MACアドレスを使ってパケットがやりとりされます。
この仕組は次の章でお話したいと思います。

## ネットワーク

使う単語
 - エンドホスト

本章の最後にTCP/IPネットワークの概要を扱います。

みなさんがご利用されている様々な会社から販売されているWindows製のPCやApple社が販売しているMacは、
オフィスや自宅のネットワークに接続してインターネットを利用したりファイルサーバーに接続することができます。
製品として異なるものなのにどうしてお互いに接続できるかというと「TCP/IPという規格に沿って通信する」と決められているからです。
かなり昔はコンピュータの販売企業ごとに独自の通信プロトコルを開発していたため、
異なる企業のコンピューター同士で通信をさせるのは難しかったです。
様々な歴史的な経緯を経て現在は「TCP/IP」という規格にほぼ統一されていますので、
TCP/IPを正しく理解することでネットワークを理解することができます。
ただ、それに加えてネットワーク機器がTCP/IPの情報を見て、どのように判断し、
どのようにデータを流す(他の機器に転送する)かをしっかり理解することが重要です。

TCPとIPは単独ではネットワークで使われる単独のプロトコル(ルール)に過ぎませんが、
「TCP/IP」とまとめられる場合は現在使われているネットワークプロトコルの総称になります。
つまりイーサネットやUDP、HTTPといったアプリケーションのプロトコルも含まれます。

TCP/IPの詳細な話はネットワークの中をどういうルールでパケットが流れていくかをしっかり学んだ上で、
第6章で実際に流れているパケットを見ながら踏み込みます。
ただ、第二章から第五章までの内容を理解するためにTCP/IPの以下の知識が必要となります。

 - レイヤーごとのカプセル化と役割
 - IPアドレスとMACアドレス
 - ネットワークアドレスとサブネットマスク
 - ネットワークのサブネット化

インターフェース層:同じネットワーク内の通信
インターネット層:ホストからホストへの通信
トランスポート層:順序など
アプリケーション層:使う側

## コラム

自宅からサービスプロバイダーまでの接続
GPON、GEPON
帯域保証とベストエフォート。お金
